<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ThinkTalk Mobile v2.7</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

<style>
/* ... (Ton CSS reste inchangé) ... */
:root { --accent: #00a2e8; --bg: #000; --nav-h: 65px; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; height: 100%; overflow: hidden;}
#panorama { display: flex; width: 300vw; height: 100%; transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); }
.view { width: 100vw; height: 100%; display: flex; flex-direction: column; padding: 20px 20px 0 20px; position: relative;}
.page-title { font-size: 13px; text-transform: uppercase; font-weight: 600; letter-spacing: 2px; opacity: 0.7; }
.section-header { font-size: 50px; font-weight: 100; margin-bottom: 20px; color: var(--accent); }
.scroll-area { flex: 1; overflow-y: auto; padding-bottom: 140px; }
#chat-bar { position: fixed; bottom: var(--nav-h); left: 0; width: 100%; padding: 8px; background: #111; display: none; align-items: center; gap: 8px; z-index: 95; border-top: 1px solid #222;}
#chat-bar input { flex: 1; min-width: 0; height: 42px; padding: 0 12px; font-size: 16px; border: none; border-radius: 6px; background: #fff; color: #000; outline: none;}
#chat-bar button { height: 42px; padding: 0 18px; background: var(--accent); border: none; border-radius: 6px; color: #fff; font-weight: bold; flex-shrink: 0;}
.nav-bottom { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-h); background: #000; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; z-index: 100;}
.nav-item { font-size: 11px; text-transform: uppercase; color: #666; font-weight: bold; }
.nav-item.active { color: #fff; border-bottom: 2px solid var(--accent); }
.tiles-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.tile { background: var(--accent); aspect-ratio: 1/1; padding: 15px; display: flex; align-items: flex-end; font-size: 18px; font-weight: 600; }
.list-item { padding: 15px 10px; border-bottom: 1px solid #222; font-size: 22px; font-weight: 300; }
.msg-bubble { margin-bottom: 15px; border-left: 3px solid var(--accent); padding-left: 12px; }
.msg-pseudo { color: var(--accent); font-size: 12px; font-weight: bold; }
.msg-text { font-size: 19px; font-weight: 300; word-wrap: break-word; }
#msg-menu { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; padding: 10px; border-radius: 10px; display: none; z-index: 999;}
#msg-menu button { width: 100%; padding: 10px; border: none; color: #fff; margin-top: 5px; border-radius: 6px;}
#edit-btn { background: #00a2e8; }
#delete-btn { background: #e81123; }
#popup { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000;}
#popup-box { background: #111; border: 2px solid var(--accent); padding: 20px; width: 80%; max-width: 300px; text-align: center;}
#popup-title { font-size: 20px; margin-bottom: 10px; color: var(--accent);}
#popup-msg { font-size: 16px; margin-bottom: 20px;}
#popup-ok { background: var(--accent); border: none; padding: 10px 20px; color: #fff; font-weight: bold; width: 100%;}
#auth { position: fixed; inset: 0; background: #000; z-index: 1000; padding: 40px 20px; }
.hidden { display: none !important; }
#add-contact-top { width: 100%; padding: 12px; margin-bottom: 10px; background: none; border: 2px solid #fff; color: #fff; font-weight: bold; text-transform: uppercase;}
</style>
</head>
<body>

<div id="popup"><div id="popup-box"><div id="popup-title">THINKTALK</div><div id="popup-msg"></div><button id="popup-ok">OK</button></div></div>

<div id="auth">
    <div class="page-title">THINKTALK</div>
    <h1 class="section-header">identification</h1>
    <input id="pseudo" type="text" placeholder="pseudo" style="width:100%; padding:15px; margin-bottom:10px; border:none;">
    <input id="code" type="password" placeholder="code" style="width:100%; padding:15px; margin-bottom:20px; border:none;">
    <button onclick="handleAuth('login')" style="width:100%; padding:15px; background:var(--accent); color:#fff; border:none; font-weight:bold;">CONNEXION</button>
    <button onclick="handleAuth('register')" style="width:100%; padding:10px; background:none; color:#888; border:none; margin-top:10px;">créer un compte</button>
</div>

<div id="panorama">
    <section class="view">
        <div class="page-title">THINKTALK</div>
        <h1 class="section-header">accueil</h1>
        <div class="tiles-container">
            <div class="tile" onclick="openRoom('general', 'room')">#general</div>
            <div class="tile" onclick="openRoom('gaming', 'room')">#gaming</div>
            <div class="tile" style="background:#333" onclick="goTo(2)">contacts</div>
            <div class="tile" style="background:#e81123" onclick="logout()">quitter</div>
        </div>
    </section>

    <section class="view">
        <div class="page-title">DISCUTER</div>
        <h1 class="section-header" id="chat-title">salon</h1>
        <div id="message-container" class="scroll-area"></div>
    </section>

    <section class="view">
        <div class="page-title">PERSONNES</div>
        <h1 class="section-header">contacts</h1>
        <button id="add-contact-top" onclick="addContactPrompt()">+ ajouter un contact</button>
        <div id="contacts-list" class="scroll-area"></div>
    </section>
</div>

<div id="chat-bar"><input id="msgInput" type="text" placeholder="répondre..."><button onclick="send()">OK</button></div>
<div id="msg-menu"><button id="edit-btn">Modifier</button><button id="delete-btn">Supprimer</button></div>

<nav class="nav-bottom">
    <div class="nav-item active" onclick="goTo(0)">accueil</div>
    <div class="nav-item" onclick="goTo(1)">chat</div>
    <div class="nav-item" onclick="goTo(2)">contacts</div>
</nav>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCrgPMXzSyS6NXNajPxr0x_J-CTESOtp5w",
  authDomain: "chat-github-6abb5.firebaseapp.com",
  databaseURL: "https://chat-github-6abb5-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-github-6abb5",
  storageBucket: "chat-github-6abb5.firebasestorage.app",
  messagingSenderId: "1038562300660",
  appId: "1:1038562300660:web:b57b74a7539466e16384a1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const messaging = firebase.messaging(); // Initialisation Push

let user = localStorage.getItem('tt_user');
let currentCtx = { id: 'general', type: 'room' };
let selectedMessage = null;

/* LOGIQUE NOTIFICATIONS PUSH */
async function initNotifications() {
    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            const token = await messaging.getToken({
                vapidKey: 'TON_VAPID_KEY_DE_FIREBASE' // Remplace par ta clé publique VAPID de la console Firebase
            });
            if (token && user) {
                // On enregistre le token de l'appareil dans la base pour ce pseudo
                await db.ref(`users/${user}/pushToken`).set(token);
            }
        }
    } catch (error) {
        console.error("Erreur Push:", error);
    }
}

// Interception des messages quand le site est ouvert
messaging.onMessage((payload) => {
    // Si on est déjà sur le site, on peut montrer une alerte visuelle discrète ou juste laisser le chat s'actualiser
    console.log('Message reçu en premier plan:', payload);
});

/* POPUP */
function showPopup(msg) {
    document.getElementById("popup-msg").textContent = msg;
    document.getElementById("popup").style.display = "flex";
}
document.getElementById("popup-ok").onclick = () => { document.getElementById("popup").style.display = "none"; };

/* Navigation */
function goTo(index) {
    document.getElementById('panorama').style.transform = `translateX(-${index * 100}vw)`;
    document.querySelectorAll('.nav-item').forEach((n, i) => n.classList.toggle('active', i === index));
    document.getElementById('chat-bar').style.display = (index === 1) ? 'flex' : 'none';
}

/* Auth */
async function handleAuth(type) {
    const p = document.getElementById('pseudo').value.trim();
    const c = document.getElementById('code').value.trim();
    if (!p || c.length < 4) return showPopup("Pseudo et code requis");

    const userRef = db.ref('users/' + p);
    const snap = await userRef.get();

    if (type === 'register') {
        if (snap.exists()) return showPopup("Ce pseudo est déjà utilisé");
        await userRef.set({ code: c });
        showPopup("Compte créé, connectez-vous");
    } else {
        if (!snap.exists() || snap.val().code !== c) return showPopup("Identifiants incorrects");
        user = p;
        localStorage.setItem('tt_user', p);
        document.getElementById('auth').classList.add('hidden');
        initNotifications(); // Activer les notifications après connexion
        loadContacts();
        openRoom('general', 'room');
    }
}

/* Chat */
function openRoom(id, type) {
    currentCtx = { id, type };
    document.getElementById('chat-title').textContent = (type === 'room' ? '#' : '') + id;
    listenMessages();
    goTo(1);
}

function listenMessages() {
    let path = currentCtx.type === 'room' ? `messages/public/${currentCtx.id}` : `messages/dm/${getConvId(user, currentCtx.id)}`;
    const ref = db.ref(path);
    const container = document.getElementById('message-container');
    ref.off();
    container.innerHTML = "";
    ref.limitToLast(50).on('child_added', snap => {
        const m = snap.val();
        const div = document.createElement('div');
        div.className = 'msg-bubble';
        div.dataset.id = snap.key;
        div.dataset.author = m.pseudo;
        div.innerHTML = `<div class="msg-pseudo">${m.pseudo}</div><div class="msg-text">${m.text}</div>`;
        if (m.pseudo === user) {
            let pressTimer;
            div.addEventListener('touchstart', () => { pressTimer = setTimeout(() => showMessageMenu(div), 500); });
            div.addEventListener('touchend', () => clearTimeout(pressTimer));
            div.addEventListener('touchmove', () => clearTimeout(pressTimer));
            div.addEventListener('mousedown', () => { pressTimer = setTimeout(() => showMessageMenu(div), 600); });
            div.addEventListener('mouseup', () => clearTimeout(pressTimer));
            div.addEventListener('mouseleave', () => clearTimeout(pressTimer));
        }
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    });
}

function send() {
    const input = document.getElementById('msgInput');
    const txt = input.value.trim();
    if (!txt || !user) return;
    let path = currentCtx.type === 'room' ? `messages/public/${currentCtx.id}` : `messages/dm/${getConvId(user, currentCtx.id)}`;
    db.ref(path).push({ pseudo: user, text: txt, timestamp: Date.now() });
    input.value = "";
}

/* Menu message */
function showMessageMenu(div) { selectedMessage = div; document.getElementById('msg-menu').style.display = 'block'; }
document.addEventListener('click', (e) => {
    const menu = document.getElementById('msg-menu');
    if (menu.style.display === 'none') return;
    if (!menu.contains(e.target) && !e.target.classList.contains('msg-bubble')) { menu.style.display = 'none'; selectedMessage = null; }
});
document.getElementById('delete-btn').onclick = () => {
    if (!selectedMessage) return;
    const id = selectedMessage.dataset.id;
    let path = currentCtx.type === 'room' ? `messages/public/${currentCtx.id}/${id}` : `messages/dm/${getConvId(user, currentCtx.id)}/${id}`;
    db.ref(path).remove();
    selectedMessage.remove();
    document.getElementById('msg-menu').style.display = 'none';
    selectedMessage = null;
};
document.getElementById('edit-btn').onclick = () => {
    if (!selectedMessage) return;
    const id = selectedMessage.dataset.id;
    const textEl = selectedMessage.querySelector('.msg-text');
    const oldText = textEl.textContent;
    const newText = prompt("Modifier le message :", oldText);
    if (!newText || newText === oldText) return;
    let path = currentCtx.type === 'room' ? `messages/public/${currentCtx.id}/${id}` : `messages/dm/${getConvId(user, currentCtx.id)}/${id}`;
    db.ref(path).update({ text: newText });
    textEl.textContent = newText;
    document.getElementById('msg-menu').style.display = 'none';
    selectedMessage = null;
};

/* Contacts */
async function loadContacts() {
    const list = document.getElementById('contacts-list');
    const snap = await db.ref('contacts/' + user).get();
    list.innerHTML = "";
    if (snap.exists()) {
        Object.keys(snap.val()).forEach(name => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.textContent = name;
            div.onclick = () => openRoom(name, 'dm');
            list.appendChild(div);
        });
    }
}
async function addContactPrompt() {
    const target = prompt("Pseudo :");
    if (!target || target === user) return showPopup("Pseudo invalide");
    const check = await db.ref('users/' + target).get();
    if (!check.exists()) return showPopup("Ce pseudo n'existe pas");
    await db.ref(`contacts/${user}/${target}`).set(true);
    await db.ref(`contacts/${target}/${user}`).set(true);
    loadContacts();
    showPopup("Contact ajouté");
}

/* Utils */
function getConvId(a, b) { return [a, b].sort().join("__"); }
function logout() { localStorage.clear(); location.reload(); }

/* Auto-login */
window.onload = () => {
    if (user) { 
        document.getElementById('auth').classList.add('hidden');
        initNotifications(); // Activer pour les sessions persistantes
        loadContacts();
        openRoom('general', 'room');
    }
};
</script>
</body>
</html>
