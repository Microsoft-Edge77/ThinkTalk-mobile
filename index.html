<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ThinkTalk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --accent: #00a2e8; 
            --bg-dark: #000000;
            --tile-bg: #1a1a1a;
            --nav-h: 70px; 
            --chat-bar-h: 65px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body, html { background: var(--bg-dark); color: #fff; height: 100vh; width: 100vw; overflow: hidden; }

        /* --- MODALE STYLE METRO --- */
        #metro-modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            z-index: 10000; display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .metro-modal { 
            background: #000; border: 2px solid var(--accent); width: 100%; max-width: 400px; padding: 30px; 
        }
        .metro-modal h3 { font-weight: 100; font-size: 24px; margin-bottom: 20px; text-transform: lowercase; }
        .metro-input { width: 100%; padding: 12px; background: #111; border: 2px solid #333; color: #fff; margin-bottom: 15px; outline: none; }
        .metro-input:focus { border-color: var(--accent); }
        .metro-btn-row { display: flex; gap: 10px; }
        .metro-btn { flex: 1; padding: 12px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-blue { background: var(--accent); color: #fff; }
        .btn-gray { background: #333; color: #fff; }

        /* --- MENU ACTIONS MESSAGES (APPUI LONG) --- */
        #msg-context-menu { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9000; display: none; align-items: center; justify-content: center; }

        /* --- ELEMENTS COMMUNS --- */
        .brand-header { text-align: center; font-weight: 100; font-size: 14px; letter-spacing: 6px; text-transform: uppercase; margin: 10px 0; color: var(--accent); }
        .search-box { width: 100%; padding: 10px; background: #000; border: 1px solid #333; color: #fff; margin-bottom: 10px; font-size: 13px; }
        .add-btn-wide { width: 100%; padding: 12px; background: none; border: 1px dashed var(--accent); color: var(--accent); font-weight: bold; margin-bottom: 15px; cursor: pointer; }

        /* --- PC LAYOUT --- */
        #pc-layout { display: none; height: 100vh; width: 100vw; }
        #sidebar { width: 320px; border-right: 2px solid #222; padding: 25px; display: flex; flex-direction: column; }
        #main-chat { flex: 1; display: flex; flex-direction: column; padding: 30px; }

        /* --- MOBILE LAYOUT --- */
        #mobile-layout { display: none; height: 100vh; width: 100vw; position: relative; }
        #panorama { display: flex; width: 300vw; height: 100%; transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); }
        .view { width: 100vw; height: 100%; padding: 20px 20px 140px 20px; display: flex; flex-direction: column; overflow: hidden; }
        .tiles-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; overflow-y: auto; }
        .tile { background: var(--accent); padding: 15px; height: 100px; display: flex; align-items: flex-end; font-weight: bold; cursor: pointer; }
        
        /* --- MESSAGES --- */
        .msg-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { background: #111; padding: 12px; border-left: 3px solid var(--accent); align-self: flex-start; max-width: 85%; position: relative; }
        .msg-u { color: var(--accent); font-size: 11px; font-weight: bold; margin-bottom: 3px; display: block; }

        /* --- NAV & BARS --- */
        .nav-bottom { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-h); background: #000; border-top: 1px solid #222; display: flex; z-index: 1000; }
        .nav-btn { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; color: #444; }
        .nav-btn.active { color: #fff; border-bottom: 3px solid var(--accent); }
        #chat-bar-mob { position: fixed; bottom: var(--nav-h); left: 0; width: 100%; height: var(--chat-bar-h); background: #111; display: none; padding: 10px; gap: 8px; z-index: 1001; }

        @media (min-width: 851px) { #pc-layout { display: flex; } }
        @media (max-width: 850px) { #mobile-layout { display: block; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="metro-modal-overlay">
        <div class="metro-modal">
            <h3 id="modal-title">titre</h3>
            <div id="modal-content"></div>
            <div class="metro-btn-row">
                <button class="metro-btn btn-gray" onclick="closeModal()">Annuler</button>
                <button class="metro-btn btn-blue" id="modal-confirm">Valider</button>
            </div>
        </div>
    </div>

    <div id="msg-context-menu" onclick="this.style.display='none'">
        <div class="metro-modal" onclick="event.stopPropagation()">
            <h3 id="ctx-msg-title">Message</h3>
            <button class="add-btn-wide" id="ctx-edit">MODIFIER</button>
            <button class="add-btn-wide" id="ctx-delete" style="border-color:#ff5050; color:#ff5050;">SUPPRIMER</button>
            <button class="metro-btn btn-gray" style="width:100%" onclick="document.getElementById('msg-context-menu').style.display='none'">RETOUR</button>
        </div>
    </div>

    <div id="pc-layout">
        <aside id="sidebar">
            <h2 style="font-weight:100; font-size:32px; margin-bottom:20px;">dashboard</h2>
            <input type="text" class="search-box" placeholder="rechercher salon..." oninput="filterList('pc-rooms', this.value)">
            <button class="add-btn-wide" onclick="uiCreateRoom()">+ NOUVEAU SALON</button>
            <div id="pc-rooms" style="flex:1; overflow-y:auto;"></div>
            
            <input type="text" class="search-box" placeholder="rechercher contact..." oninput="filterList('pc-contacts', this.value)">
            <button class="add-btn-wide" onclick="uiAddContact()">+ AJOUTER UN AMI</button>
            <div id="pc-contacts" style="flex:1; overflow-y:auto; margin-top:10px;"></div>
            <button onclick="logout()" style="color:#ff5050; background:none; border:none; text-align:left; cursor:pointer; font-weight:bold; margin-top:10px;">DÉCONNEXION</button>
        </aside>
        <main id="main-chat">
            <h2 id="chat-title-pc" style="font-weight:100; font-size:42px;">#accueil</h2>
            <div id="msg-pc" class="msg-list"></div>
            <div style="display:flex; gap:10px; padding-top:20px;">
                <input id="in-pc" style="flex:1; padding:15px; background: #111; border: 2px solid #333; color:#fff; outline:none;" placeholder="Message..." onkeypress="if(event.key==='Enter') send('pc')">
                <button onclick="send('pc')" style="padding: 0 30px; background: var(--accent); border:none; color:#fff; font-weight:bold;">ENVOYER</button>
            </div>
        </main>
    </div>

    <div id="mobile-layout">
        <div id="panorama">
            <section class="view">
                <div class="brand-header">THINKTALK</div>
                <h1 style="font-weight:100; font-size:42px; color:var(--accent);">salons</h1>
                <input type="text" class="search-box" placeholder="rechercher..." oninput="filterTiles('mob-rooms', this.value)">
                <button class="add-btn-wide" onclick="uiCreateRoom()">+ NOUVEAU SALON</button>
                <div id="mob-rooms" class="tiles-grid"></div>
            </section>

            <section class="view" style="background-size:cover; background-position:center;" id="chat-view-mob">
                <h1 id="chat-title-mob" style="font-weight:100; font-size:32px; margin-bottom:10px;">Chat</h1>
                <div id="msg-mob" class="msg-list"></div>
            </section>

            <section class="view">
                <h1 style="font-weight:100; font-size:42px; color:var(--accent);">contacts</h1>
                <input type="text" class="search-box" placeholder="rechercher..." oninput="filterTiles('mob-contacts', this.value)">
                <button class="add-btn-wide" onclick="uiAddContact()">+ AJOUTER AMI</button>
                <div id="mob-contacts" class="tiles-grid"></div>
            </section>
        </div>
        <div id="chat-bar-mob">
            <input id="in-mob" style="flex:1; background:#000; border:1px solid #333; color:#fff; padding:0 15px;" placeholder="Message..." onkeypress="if(event.key==='Enter') send('mob')">
            <button onclick="send('mob')" style="background:var(--accent); border:none; color:#fff; padding:0 20px; font-weight:bold;">OK</button>
        </div>
        <nav class="nav-bottom">
            <div class="nav-btn active" onclick="goTo(0)">ACCUEIL</div>
            <div class="nav-btn" onclick="goTo(1)">CHAT</div>
            <div class="nav-btn" onclick="goTo(2)">CONTACTS</div>
        </nav>
    </div>

    <script>
        // --- CONFIG FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCrgPMXzSyS6NXNajPxr0x_J-CTESOtp5w",
            authDomain: "chat-github-6abb5.firebaseapp.com",
            databaseURL: "https://chat-github-6abb5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chat-github-6abb5",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let user = localStorage.getItem("thinktalk_pseudo");
        let current = { id: 'general', type: 'room' };
        let longPressTimer;

        // --- UTILS METRO MODAL ---
        function openModal(title, contentHtml, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = contentHtml;
            document.getElementById('metro-modal-overlay').style.display = 'flex';
            document.getElementById('modal-confirm').onclick = () => { onConfirm(); closeModal(); };
        }
        function closeModal() { document.getElementById('metro-modal-overlay').style.display = 'none'; }

        // --- NAVIGATION ---
        function goTo(idx) {
            document.getElementById('panorama').style.transform = `translateX(-${idx * 100}vw)`;
            document.querySelectorAll('.nav-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
            document.getElementById('chat-bar-mob').style.display = (idx === 1) ? 'flex' : 'none';
        }

        // --- CORE LOGIC ---
        function init() {
            if(!user) {
                openModal("connexion", `<input id="authP" class="metro-input" placeholder="pseudo"><input id="authC" type="password" class="metro-input" placeholder="code">`, async () => {
                    const p = document.getElementById('authP').value.trim();
                    const c = document.getElementById('authC').value.trim();
                    const snap = await db.ref('users/'+p).get();
                    if(snap.exists() && snap.val().code === c) {
                        user = p; localStorage.setItem("thinktalk_pseudo", p); location.reload();
                    } else { alert("Erreur"); location.reload(); }
                });
                return;
            }
            loadData();
            setChat('general', 'room');
        }

        function loadData() {
            db.ref("rooms").on('value', snap => {
                const pc = document.getElementById('pc-rooms');
                const mob = document.getElementById('mob-rooms');
                pc.innerHTML = ""; mob.innerHTML = "";
                snap.forEach(c => {
                    pc.innerHTML += `<div class="pc-item" onclick="setChat('${c.key}','room')" style="padding:12px; background:#111; margin-bottom:5px; cursor:pointer;">#${c.key}</div>`;
                    mob.innerHTML += `<div class="tile" onclick="setChat('${c.key}','room'); goTo(1);">#${c.key}</div>`;
                });
            });
            db.ref("contacts/"+user).on('value', snap => {
                const pc = document.getElementById('pc-contacts');
                const mob = document.getElementById('mob-contacts');
                pc.innerHTML = ""; mob.innerHTML = "";
                snap.forEach(c => {
                    pc.innerHTML += `<div class="pc-item" onclick="setChat('${c.key}','dm')" style="padding:12px; background:#111; margin-bottom:5px; cursor:pointer;">@${c.key}</div>`;
                    mob.innerHTML += `<div class="tile" style="background:#1a1a1a" onclick="setChat('${c.key}','dm'); goTo(1);">@${c.key}</div>`;
                });
            });
        }

        function setChat(id, type) {
            current = { id, type };
            const title = (type === 'room' ? '#' : '@') + id;
            document.getElementById('chat-title-pc').textContent = title;
            document.getElementById('chat-title-mob').textContent = title;
            const path = type === 'room' ? `messages/public/${id}` : `messages/dm/${[user, id].sort().join("__")}`;
            db.ref(path).off();
            db.ref(path).on('value', snap => {
                const pc = document.getElementById('msg-pc');
                const mob = document.getElementById('msg-mob');
                pc.innerHTML = ""; mob.innerHTML = "";
                snap.forEach(c => {
                    const m = c.val();
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'msg';
                    msgDiv.innerHTML = `<span class="msg-u">${m.pseudo}</span><div>${m.text}</div>`;
                    
                    // Event clic long (mobile) et clic droit (PC)
                    msgDiv.oncontextmenu = (e) => { e.preventDefault(); openContextMenu(c.key, m.text, m.pseudo, path); };
                    msgDiv.ontouchstart = () => longPressTimer = setTimeout(() => openContextMenu(c.key, m.text, m.pseudo, path), 600);
                    msgDiv.ontouchend = () => clearTimeout(longPressTimer);
                    
                    pc.appendChild(msgDiv.cloneNode(true)); // clone pour les deux vues
                    mob.appendChild(msgDiv);
                });
                pc.scrollTop = pc.scrollHeight; mob.scrollTop = mobBox.scrollHeight;
            });
        }

        function openContextMenu(msgId, oldText, author, path) {
            if(author !== user) return;
            document.getElementById('msg-context-menu').style.display = 'flex';
            document.getElementById('ctx-delete').onclick = () => { db.ref(path+'/'+msgId).remove(); document.getElementById('msg-context-menu').style.display = 'none'; };
            document.getElementById('ctx-edit').onclick = () => {
                document.getElementById('msg-context-menu').style.display = 'none';
                openModal("modifier", `<input id="editVal" class="metro-input" value="${oldText}">`, () => {
                    const nt = document.getElementById('editVal').value;
                    if(nt) db.ref(path+'/'+msgId).update({ text: nt + " (modifié)" });
                });
            };
        }

        function send(mode) {
            const inp = document.getElementById(mode === 'pc' ? 'in-pc' : 'in-mob');
            if(!inp.value.trim()) return;
            const path = current.type === 'room' ? `messages/public/${current.id}` : `messages/dm/${[user, current.id].sort().join("__")}`;
            db.ref(path).push({ pseudo: user, text: inp.value, timestamp: Date.now() });
            inp.value = "";
        }

        // --- FILTRES ---
        function filterList(contId, val) {
            const items = document.getElementById(contId).children;
            for(let i of items) i.style.display = i.textContent.toLowerCase().includes(val.toLowerCase()) ? "block" : "none";
        }
        function filterTiles(contId, val) {
            const items = document.getElementById(contId).children;
            for(let i of items) i.style.display = i.textContent.toLowerCase().includes(val.toLowerCase()) ? "flex" : "none";
        }

        // --- UI ACTIONS ---
        function uiCreateRoom() {
            openModal("nouveau salon", `<input id="nr-n" class="metro-input" placeholder="nom du salon">`, () => {
                const n = document.getElementById('nr-n').value.toLowerCase().trim();
                if(n) db.ref('rooms/'+n).set({creator: user});
            });
        }
        function uiAddContact() {
            openModal("ajouter ami", `<input id="ac-n" class="metro-input" placeholder="pseudo">`, () => {
                const n = document.getElementById('ac-n').value.trim();
                if(n && n !== user) { db.ref(`contacts/${user}/${n}`).set(true); db.ref(`contacts/${n}/${user}`).set(true); }
            });
        }
        function logout() { localStorage.clear(); location.reload(); }

        window.onload = init;
    </script>
</body>
</html>
