<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ThinkTalk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    :root {
      --accent: #0078d7; /* Bleu Windows profond */
      --bg: #000000;
      --text: #ffffff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; }
    body { background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; }

    /* --- FOND POUSSI√àRE BLEUE --- */
    #canvas-dust {
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
    }

    .app-root { position: relative; z-index: 1; height: 100vh; display: flex; flex-direction: column; }

    /* --- HEADER --- */
    .top-bar { padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
    .top-title { font-size: 2.5rem; font-weight: 100; color: var(--accent); display: none; }
    .top-title.active { display: block; }
    .hamburger { font-size: 24px; cursor: pointer; color: var(--text); z-index: 101; }

    /* --- SECTIONS (ACCUEIL / CHAT / CONTACTS) --- */
    .view-container { flex: 1; position: relative; overflow-y: auto; padding: 10px; }
    .view-section { display: none; width: 100%; }
    .view-section.active { display: block; }

    /* Barre recherche et Cr√©er */
    .action-box { 
      background: #000; border: 1px solid var(--accent); 
      padding: 12px; margin-bottom: 10px; border-radius: 2px;
    }
    input { width: 100%; background: transparent; border: none; color: #fff; outline: none; font-size: 1rem; }

    /* --- GRILLE DE TUILES MOSA√èQUE --- */
    .tiles-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: 100px;
      gap: 10px;
      transition: all 0.5s ease-in-out;
    }
    
    /* Animation envol vers l'ext√©rieur */
    .tiles-grid.fly-out .tile:nth-child(odd) { transform: translateX(-150vw) rotate(-20deg); opacity: 0; }
    .tiles-grid.fly-out .tile:nth-child(even) { transform: translateX(150vw) rotate(20deg); opacity: 0; }

    .tile {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 15px; display: flex; flex-direction: column; justify-content: flex-end;
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s;
      cursor: pointer; position: relative; overflow: hidden;
    }
    .tile-1x1 { grid-column: span 1; grid-row: span 1; }
    .tile-2x1 { grid-column: span 2; grid-row: span 1; }
    .tile-2x2 { grid-column: span 2; grid-row: span 2; }

    /* --- CHAT --- */
    #chat-view { height: 100%; display: none; flex-direction: column; }
    #chat-view.active { display: flex; animation: fadeIn 1s; }
    #chat-messages { flex: 1; overflow-y: auto; padding-bottom: 80px; }
    
    .msg-block { 
      margin-bottom: 15px; opacity: 0; animation: materialize 0.8s forwards; 
    }
    @keyframes materialize { from { filter: blur(10px); opacity: 0; } to { filter: blur(0); opacity: 1; } }
    
    .msg-header { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--accent); margin-bottom: 4px; }
    .msg-text { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 2px; border-left: 2px solid var(--accent); color: var(--text); }

    /* --- BARRE DE SAISIE --- */
    .input-row { 
      position: fixed; bottom: 60px; left: 0; right: 0; 
      display: flex; background: #000; padding: 10px; gap: 5px; 
    }
    .btn-sq { width: 45px; height: 45px; background: #000; border: 1px solid #333; color: var(--accent); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .input-box { flex: 1; border: 1px solid #333; padding: 10px; color: var(--accent); }

    /* --- NAVIGATION BAS --- */
    .bottom-nav { 
      position: fixed; bottom: 0; width: 100%; height: 56px; 
      display: flex; background: #000; border-top: 1px solid #222; z-index: 100;
    }
    .nav-btn { flex: 1; display: flex; align-items: center; justify-content: center; color: #888; text-transform: lowercase; font-size: 0.9rem; }
    .nav-btn.active { color: #fff; font-weight: bold; }

    /* --- MENU OVERLAY --- */
    #menu-overlay { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; 
      display: none; align-items: center; justify-content: center; flex-direction: column;
    }
    .logout-btn { color: #ff4444; font-size: 1.5rem; cursor: pointer; }
  </style>
</head>
<body>

  <canvas id="canvas-dust"></canvas>

  <div id="menu-overlay">
    <div class="logout-btn" onclick="logout()">D√©connexion</div>
    <div style="margin-top:40px; cursor:pointer;" onclick="toggleMenu()">Fermer</div>
  </div>

  <div class="app-root">
    <div class="top-bar">
      <div id="main-title" class="top-title active">ThinkTalk</div>
      <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>
    </div>

    <div class="view-container">
      <section id="view-home" class="view-section active">
        <div class="action-box"><input type="text" placeholder="Rechercher un salon..."></div>
        <div class="action-box" onclick="createRoom()" style="cursor:pointer; text-align:center;">+ Cr√©er un salon</div>
        <div class="tiles-grid" id="rooms-grid"></div>
      </section>

      <section id="view-chat" class="view-section">
        <div id="chat-messages"></div>
        <div class="input-row">
          <button class="btn-sq" onclick="alert('Fichiers')">üìé</button>
          <input type="text" id="chat-input" class="input-box" placeholder="r√©pondre...">
          <button class="btn-sq" id="send-btn" style="color:#fff; background:var(--accent)">OK</button>
        </div>
      </section>

      <section id="view-contacts" class="view-section">
        <div class="tiles-grid" id="contacts-grid"></div>
      </section>
    </div>

    <nav class="bottom-nav">
      <div class="nav-btn active" onclick="switchTab('home')">accueil</div>
      <div class="nav-btn" onclick="switchTab('chat')">chat</div>
      <div class="nav-btn" onclick="switchTab('contacts')">contacts</div>
    </nav>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCv4nD9Nyez5ERGvW47q-6O-TA96zWJn0M",
    authDomain: "thinktalk-b3c85.firebaseapp.com",
    projectId: "thinktalk-b3c85",
    storageBucket: "thinktalk-b3c85.firebasestorage.app",
    messagingSenderId: "752141817301",
    appId: "1:752141817301:web:28fecaf81db27eb51d595c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- ENGINE DE POUSSI√àRE ---
  const canvas = document.getElementById('canvas-dust');
  const ctx = canvas.getContext('2d');
  let particles = [];
  function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
  window.onresize = resize; resize();

  class Particle {
    constructor() { this.reset(); }
    reset() {
      this.x = Math.random() * canvas.width;
      this.y = Math.random() * canvas.height;
      this.vx = (Math.random() - 0.5) * 0.5;
      this.vy = (Math.random() - 0.5) * 0.5;
      this.size = Math.random() * 2;
    }
    update() {
      this.x += this.vx; this.y += this.vy;
      if(this.x<0 || this.x>canvas.width || this.y<0 || this.y>canvas.height) this.reset();
    }
    draw() {
      ctx.fillStyle = "rgba(0, 120, 215, 0.3)";
      ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
    }
  }
  for(let i=0; i<100; i++) particles.push(new Particle());
  function animate() {
    ctx.clearRect(0,0,canvas.width, canvas.height);
    particles.forEach(p => { p.update(); p.draw(); });
    requestAnimationFrame(animate);
  }
  animate();

  // --- NAVIGATION ---
  window.switchTab = (target) => {
    document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('view-' + target).classList.add('active');
    document.querySelector(`[onclick="switchTab('${target}')"]`).classList.add('active');
    document.getElementById('main-title').classList.toggle('active', target === 'home');
  };

  window.toggleMenu = () => {
    const m = document.getElementById('menu-overlay');
    m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
  };

  // --- LOGIQUE SALONS ---
  const roomsGrid = document.getElementById('rooms-grid');
  onSnapshot(collection(db, "rooms"), (snap) => {
    roomsGrid.innerHTML = "";
    let i = 0;
    snap.forEach(doc => {
      const room = doc.data();
      const div = document.createElement('div');
      const types = ['tile-1x1', 'tile-2x1', 'tile-2x2'];
      div.className = `tile ${types[i % 3]}`;
      div.innerHTML = `<span># ${room.name}</span>`;
      div.onclick = () => openRoom(room.name, room.code);
      roomsGrid.appendChild(div);
      i++;
    });
  });

  window.createRoom = async () => {
    const name = prompt("Nom du salon (unique) :");
    if(!name) return;
    const code = prompt("Code priv√© (laisser vide si public) :");
    // V√©rification unicit√© via Firestore (simplifi√©e ici)
    await addDoc(collection(db, "rooms"), { name: name, code: code || null });
  };

  // --- LOGIQUE CHAT ---
  let currentRoom = "";
  let unsub = null;
  function openRoom(name, code) {
    if(code) {
      const pass = prompt("Code requis :");
      if(pass !== code) return alert("Acc√®s refus√©");
    }
    
    // Animation envol
    roomsGrid.classList.add('fly-out');
    setTimeout(() => {
      currentRoom = name;
      switchTab('chat');
      roomsGrid.classList.remove('fly-out');
      loadMessages(name);
    }, 600);
  }

  function loadMessages(room) {
    if(unsub) unsub();
    const q = query(collection(db, "messages"), where("room", "==", room), orderBy("timestamp", "asc"));
    unsub = onSnapshot(q, (snap) => {
      const box = document.getElementById('chat-messages');
      box.innerHTML = "";
      snap.forEach(d => {
        const m = d.data();
        const date = m.timestamp ? new Date(m.timestamp.seconds*1000).toLocaleTimeString() : "";
        box.innerHTML += `
          <div class="msg-block">
            <div class="msg-header"><span>MOI</span><span>${date}</span></div>
            <div class="msg-text">${m.text}</div>
          </div>`;
      });
      box.scrollTop = box.scrollHeight;
    });
  }

  document.getElementById('send-btn').onclick = async () => {
    const input = document.getElementById('chat-input');
    if(!input.value || !currentRoom) return;
    await addDoc(collection(db, "messages"), {
      text: input.value, room: currentRoom, timestamp: serverTimestamp()
    });
    input.value = "";
  };

</script>
</body>
</html>
