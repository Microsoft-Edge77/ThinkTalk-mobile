<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ThinkTalk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        :root { --accent: #00a2e8; --bg: #000; --nav-h: 70px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; }
        
        /* Layouts */
        #pc-layout, #mobile-layout, #panorama, .view { background: transparent !important; }
        #pc-layout { display: none; height: 100vh; }
        #sidebar { width: 280px; border-right: 1px solid #222; padding: 15px; display: flex; flex-direction: column; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); }
        
        /* Messages (Style demandÃ© : AlignÃ©s Ã  gauche, saut de ligne) */
        .msg-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 15px; }
        .msg { 
            background: rgba(255,255,255,0.07); 
            padding: 10px; 
            border-left: 4px solid #333; 
            width: fit-content;
            max-width: 90%; 
            align-self: flex-start; 
            word-wrap: break-word; 
            overflow-wrap: break-word;
            position: relative;
        }
        .msg.mine { border-left-color: var(--accent); }
        .msg-header { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 5px; color: var(--accent); font-weight: bold; gap: 20px; }
        .msg-time { color: #666; font-weight: normal; }
        .msg-text { font-size: 15px; line-height: 1.4; color: #eee; white-space: pre-wrap; }
        
        .msg-actions { margin-top: 8px; display: flex; gap: 10px; opacity: 0.6; }
        .msg-actions span { font-size: 10px; cursor: pointer; text-transform: uppercase; color: #888; }
        .msg-actions span:hover { color: #fff; }

        /* Tiles Style (Transparentes & Live) */
        .tiles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .tile { 
            background: rgba(0, 162, 232, 0.7); /* Transparence accent */
            padding: 12px; height: 110px; display: flex; flex-direction: column; justify-content: flex-end;
            font-weight: bold; cursor: pointer; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        .tile:active { transform: scale(0.95); }
        .tile.private { background: rgba(50, 50, 50, 0.7); border: 1px solid var(--accent); }
        
        .tile .tile-label { font-size: 14px; z-index: 2; text-transform: lowercase; }
        .tile .live-preview { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            padding: 10px; background: inherit; display: flex; flex-direction: column;
            font-size: 11px; font-weight: normal; animation: slideUp 0.5s ease-out;
        }
        .live-author { color: #fff; font-weight: bold; margin-bottom: 2px; font-size: 10px; opacity: 0.8; }
        .live-text { overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* UI elements */
        .metro-input { width: 100%; padding: 12px; background: #111; border: 2px solid #333; color: #fff; margin-bottom: 10px; outline: none; }
        .btn-action-metro { padding: 10px; font-size: 11px; background: rgba(255,255,255,0.05); color: #fff; border: 1px solid #333; cursor: pointer; text-align: left; text-transform: uppercase; margin-bottom: 5px; width: 100%; }
        .search-box { width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid #333; color: #fff; margin-bottom: 15px; outline: none; }

        #mobile-layout { display: none; height: 100vh; padding-top: 60px; }
        .mobile-header { position: fixed; top: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.8); display: flex; align-items: center; padding: 0 20px; z-index: 900; }
        #panorama { display: flex; width: 300vw; height: 100%; transition: transform 0.6s cubic-bezier(0.1, 0.7, 0.1, 1); }
        .view { width: 100vw; height: 100%; padding: 15px; overflow-y: auto; padding-bottom: 150px; }
        
        .input-area { display: flex; gap: 8px; padding: 10px; background: #000; border-top: 1px solid #222; }
        .input-area input { flex: 1; padding: 12px; background: #111; border: 1px solid #333; color: #fff; outline: none; }
        .btn-send { background: var(--accent); border: none; color: #fff; font-weight: bold; padding: 0 20px; cursor: pointer; }

        .nav-bottom { position: fixed; bottom: 0; width: 100%; height: 70px; background: #000; border-top: 1px solid #222; display: flex; }
        .nav-btn { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #555; font-weight: bold; }
        .nav-btn.active { color: #fff; border-bottom: 3px solid var(--accent); }

        @media (min-width: 851px) { #pc-layout { display: flex; } }
        @media (max-width: 850px) { #mobile-layout { display: block; } .mobile-header { display: flex; } }
    </style>
</head>
<body>

    <div id="pc-layout">
        <aside id="sidebar">
            <h1 style="color:var(--accent); font-weight:100; margin-bottom:20px;">ThinkTalk</h1>
            <div class="room-actions">
                <button class="btn-action-metro" onclick="uiCreateRoom()">+ CRÃ‰ER UN SALON</button>
                <button class="btn-action-metro" onclick="uiJoinPrivate()">ðŸ”‘ REJOINDRE PRIVÃ‰</button>
            </div>
            <div id="pc-content-list" style="flex:1; overflow-y:auto; margin-top:10px;"></div>
            <button onclick="logout()" style="background:none; border:none; color:red; cursor:pointer; text-align:left; padding:10px 0;">DÃ‰CONNEXION</button>
        </aside>
        <main style="flex:1; display:flex; flex-direction:column;">
            <div style="padding:20px; border-bottom:1px solid #222;"><h2 id="chat-title-pc" style="font-weight:100;">#accueil</h2></div>
            <div id="msg-pc" class="msg-list"></div>
            <div class="input-area">
                <input type="text" id="in-pc" placeholder="Ã‰crire..." onkeypress="if(event.key==='Enter') send('pc')">
                <button class="btn-send" onclick="send('pc')">ENVOYER</button>
            </div>
        </main>
    </div>

    <div id="mobile-layout">
        <div class="mobile-header"><span>THINKTALK</span></div>
        <div id="panorama">
            <section class="view">
                <h1 style="font-size:40px; font-weight:100; color:var(--accent); margin-bottom:20px;">salons</h1>
                <div id="mob-rooms" class="tiles-grid"></div>
            </section>
            <section class="view">
                <h2 id="chat-title-mob" style="font-weight:100; margin-bottom:10px;">Chat</h2>
                <div id="msg-mob" class="msg-list"></div>
            </section>
            <section class="view">
                <h1 style="font-size:40px; font-weight:100; color:var(--accent);">contacts</h1>
                <div id="mob-contacts" class="tiles-grid"></div>
            </section>
        </div>
        <div class="input-area" id="mob-bar" style="display:none; position:fixed; bottom:70px; width:100%;">
            <input type="text" id="in-mob" placeholder="Message..." onkeypress="if(event.key==='Enter') send('mob')">
            <button class="btn-send" onclick="send('mob')">OK</button>
        </div>
        <nav class="nav-bottom">
            <div class="nav-btn active" onclick="goTo(0)">ACCUEIL</div>
            <div class="nav-btn" onclick="goTo(1)">CHAT</div>
            <div class="nav-btn" onclick="goTo(2)">CONTACTS</div>
        </nav>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCrgPMXzSyS6NXNajPxr0x_J-CTESOtp5w",
            authDomain: "chat-github-6abb5.firebaseapp.com",
            databaseURL: "https://chat-github-6abb5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chat-github-6abb5",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let user = localStorage.getItem("thinktalk_pseudo");
        let current = { id: 'general', type: 'room' };

        function getPath(id, type) { 
            const targetId = id || current.id;
            const targetType = type || current.type;
            return targetType === 'room' ? `messages/public/${targetId}` : `messages/dm/${[user, targetId].sort().join("__")}`; 
        }

        // SystÃ¨me Live Tile
        function bindLiveTile(id, type, element) {
            db.ref(targetPath = (type === 'room' ? `messages/public/${id}` : `messages/dm/${[user, id].sort().join("__")}`))
              .limitToLast(1).on('child_added', snap => {
                const m = snap.val();
                if(!m) return;
                const prev = element.querySelector('.live-preview');
                if(prev) prev.remove();
                
                const preview = document.createElement('div');
                preview.className = 'live-preview';
                preview.innerHTML = `<div class="live-author">${m.pseudo}</div><div class="live-text">${m.text}</div>`;
                element.appendChild(preview);
                
                // Effet Metro : La preview disparaÃ®t aprÃ¨s 5s pour remontrer le nom du salon, puis revient
                setTimeout(() => { if(preview) preview.style.opacity = "0"; }, 5000);
                setTimeout(() => { if(preview) preview.style.opacity = "1"; }, 8000);
            });
        }

        function setChat(id, type) {
            current = { id, type };
            document.getElementById('chat-title-pc').textContent = (type==='room'?'#':'@') + id;
            document.getElementById('chat-title-mob').textContent = (type==='room'?'#':'@') + id;
            const path = getPath();
            db.ref(path).off();
            db.ref(path).on('value', s => {
                const pc = document.getElementById('msg-pc'), mb = document.getElementById('msg-mob');
                pc.innerHTML = ""; mb.innerHTML = "";
                s.forEach(snap => {
                    const m = snap.val();
                    const mid = snap.key;
                    const isMine = m.pseudo === user;
                    const html = `
                        <div class="msg ${isMine?'mine':''}">
                            <div class="msg-header"><span>${m.pseudo}</span><span class="msg-time">${m.time || ''}</span></div>
                            <div class="msg-text">${m.text}</div>
                            ${isMine ? `<div class="msg-actions"><span onclick="editMsg('${mid}','${m.text.replace(/'/g, "\\'")}')">Modifier</span><span onclick="deleteMsg('${mid}')">Supprimer</span></div>` : ''}
                        </div>`;
                    pc.innerHTML += html; mb.innerHTML += html;
                });
                pc.scrollTop = pc.scrollHeight; mb.scrollTop = mb.scrollHeight;
            });
        }

        function loadLists() {
            // Salons
            db.ref("rooms").on('value', s => {
                const mb = document.getElementById('mob-rooms'), pc = document.getElementById('pc-content-list');
                let saved = JSON.parse(localStorage.getItem("thinktalk_private_rooms") || "[]");
                mb.innerHTML = ""; pc.innerHTML = "";
                
                // On ajoute manuellement gÃ©nÃ©ral
                const genTile = createTile('general', 'room', false);
                mb.appendChild(genTile);
                pc.innerHTML += `<div class="btn-action-metro" onclick="setChat('general','room')">#general</div>`;
                bindLiveTile('general', 'room', genTile);

                s.forEach(r => {
                    const isPriv = r.val().code;
                    if(r.key !== 'general' && (!isPriv || saved.includes(r.key))) {
                        const tile = createTile(r.key, 'room', isPriv);
                        mb.appendChild(tile);
                        pc.innerHTML += `<div class="btn-action-metro" onclick="setChat('${r.key}','room')">${isPriv?'ðŸ”‘':'#'} ${r.key}</div>`;
                        bindLiveTile(r.key, 'room', tile);
                    }
                });
            });

            // Contacts
            db.ref("contacts/"+user).on('value', s => {
                const mc = document.getElementById('mob-contacts');
                mc.innerHTML = "";
                s.forEach(c => {
                    const tile = createTile(c.key, 'contact', false);
                    tile.style.background = "rgba(100,100,100,0.5)";
                    mc.appendChild(tile);
                    bindLiveTile(c.key, 'contact', tile);
                });
            });
        }

        function createTile(id, type, isPriv) {
            const div = document.createElement('div');
            div.className = `tile ${isPriv?'private':''}`;
            div.innerHTML = `<div class="tile-label">${isPriv?'ðŸ”‘':(type==='room'?'#':'@')} ${id}</div>`;
            div.onclick = () => { setChat(id, type); goTo(1); };
            return div;
        }

        function send(m) {
            const i = document.getElementById(m==='pc'?'in-pc':'in-mob');
            const v = i.value.trim();
            if(v && user) {
                db.ref(getPath()).push({
                    pseudo: user, text: v,
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    timestamp: Date.now()
                });
                i.value = "";
            }
        }

        function editMsg(mid, oldText) {
            const n = prompt("Modifier :", oldText);
            if(n && n !== oldText) db.ref(getPath() + "/" + mid).update({ text: n + " (modifiÃ©)" });
        }

        function deleteMsg(mid) {
            if(confirm("Supprimer ?")) db.ref(getPath() + "/" + mid).remove();
        }

        function uiCreateRoom() {
            const n = prompt("Nom du salon :"), c = prompt("Code (vide = public) :");
            if(n) {
                db.ref('rooms/'+n.toLowerCase()).set({ code: c || null });
                if(c) {
                    let s = JSON.parse(localStorage.getItem("thinktalk_private_rooms") || "[]");
                    s.push(n.toLowerCase()); localStorage.setItem("thinktalk_private_rooms", JSON.stringify(s));
                }
            }
        }

        function uiJoinPrivate() {
            const n = prompt("Nom :").toLowerCase(), c = prompt("Code :");
            db.ref('rooms/'+n).get().then(s => {
                if(s.exists() && s.val().code === c) {
                    let saved = JSON.parse(localStorage.getItem("thinktalk_private_rooms") || "[]");
                    if(!saved.includes(n)) saved.push(n);
                    localStorage.setItem("thinktalk_private_rooms", JSON.stringify(saved));
                    setChat(n, 'room'); goTo(1);
                } else alert("Erreur");
            });
        }

        function goTo(x) {
            document.getElementById('panorama').style.transform = `translateX(-${x*100}vw)`;
            document.querySelectorAll('.nav-btn').forEach((b,i) => b.classList.toggle('active', i===x));
            document.getElementById('mob-bar').style.display = (x===1) ? 'flex' : 'none';
        }

        window.onload = () => {
            if(!user) { user = prompt("Pseudo :"); localStorage.setItem("thinktalk_pseudo", user); }
            loadLists(); setChat('general', 'room');
        }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
