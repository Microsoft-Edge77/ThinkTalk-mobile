<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ThinkTalk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    :root { --accent: #0078d7; --bg: #000; --text: #fff; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; }
    body { background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; position: fixed; width: 100%; }
    #canvas-dust { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
    
    /* UI ELEMENTS */
    .app-root { position: relative; z-index: 1; height: 100vh; display: flex; flex-direction: column; display: none; }
    .top-bar { padding: 15px; display: flex; justify-content: space-between; align-items: center; height: 70px; }
    .top-title { font-size: 2.2rem; font-weight: 100; color: var(--accent); }
    .hamburger { cursor: pointer; display: flex; flex-direction: column; gap: 5px; }
    .hamburger span { display: block; width: 25px; height: 2px; background: #fff; }
    
    /* CHAT */
    #chat-messages { height: calc(100vh - 220px); overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px; }
    .msg-block { align-self: flex-start; max-width: 90%; animation: materialize 0.5s forwards; cursor: pointer; }
    .msg-content-wrapper { display: flex; align-items: flex-end; gap: 8px; }
    .msg-text { background: rgba(255,255,255,0.08); padding: 10px; border-left: 3px solid var(--accent); word-break: break-word; }
    .msg-info { font-size: 9px; color: #666; }
    .msg-img { max-width: 150px; border-radius: 4px; cursor: zoom-in; transition: transform 0.3s; }

    /* POPUPS */
    .popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 6000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(10px); }
    .popup-card { background: #000; border: 1px solid var(--accent); width: 100%; max-width: 300px; padding: 20px; }
    #fullscreen-view { position: fixed; inset: 0; z-index: 7000; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; }
    #fullscreen-img { max-width: 95%; max-height: 95%; border: 1px solid var(--accent); }

    .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 56px; display: flex; background: #000; border-top: 1px solid #222; }
    .nav-btn { flex: 1; display: flex; align-items: center; justify-content: center; color: #666; cursor: pointer; }
    .nav-btn.active { color: #fff; border-top: 2px solid var(--accent); }
    .input-box { width: 100%; background: #111; border: 1px solid #333; color: var(--accent); padding: 12px; margin-bottom: 10px; outline: none; }
    .btn-full { width: 100%; padding: 12px; background: var(--accent); border: none; color: #fff; margin-top: 10px; cursor: pointer; }
  </style>
</head>
<body>
<canvas id="canvas-dust"></canvas>
<input type="file" id="file-input" accept="image/*" style="display:none">

<div id="fullscreen-view" onclick="this.style.display='none'"><img id="fullscreen-img"></div>

<div class="popup-overlay" id="pop-alert"><div class="popup-card"><p id="alert-text"></p><button class="btn-full" onclick="closePopups()">ok</button></div></div>

<div class="popup-overlay" id="pop-create"><div class="popup-card">
    <h3>nouveau salon</h3>
    <input type="text" id="new-room-name" placeholder="nom..." class="input-box">
    <input type="password" id="new-room-code" placeholder="code (optionnel)" class="input-box">
    <button class="btn-full" id="btn-confirm-create">crÃ©er</button>
</div></div>

<div class="popup-overlay" id="pop-room-auth"><div class="popup-card">
    <h3>salon privÃ©</h3>
    <input type="password" id="room-auth-input" placeholder="code d'accÃ¨s" class="input-box">
    <button class="btn-full" id="btn-room-enter">entrer</button>
</div></div>

<div class="popup-overlay" id="pop-msg-options">
    <div class="popup-card">
        <button class="btn-full" id="btn-msg-edit">Ã©diter</button>
        <button class="btn-full" style="background:#a30000" id="btn-msg-del">supprimer</button>
        <button class="btn-full" style="background:#222" onclick="closePopups()">retour</button>
    </div>
</div>

<div id="auth-screen" style="position:fixed; inset:0; z-index:5000; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div style="font-size:3.5rem; color:var(--accent); margin-bottom:40px">thinktalk</div>
    <input type="text" id="auth-pseudo" class="input-box" style="max-width:300px" placeholder="pseudo">
    <input type="password" id="auth-code" class="input-box" style="max-width:300px" placeholder="code">
    <button class="btn-full" id="btn-login" style="max-width:300px">connexion</button>
</div>

<div class="app-root" id="main-app">
    <div class="top-bar"><div class="top-title">thinktalk</div><div class="hamburger" onclick="toggleMenu()"><span></span><span style="margin:5px 0"></span><span></span></div></div>
    <div class="view-container">
        <section id="view-home" class="view-section active"><div class="action-row"><input type="text" class="search-box" placeholder="recherche..."><button class="btn-add" onclick="document.getElementById('pop-create').style.display='flex'">+</button></div><div class="tiles-grid" id="rooms-grid"></div></section>
        <section id="view-chat" class="view-section">
            <div id="chat-header" style="color:var(--accent); margin-bottom:10px;"># gÃ©nÃ©ral</div>
            <div id="chat-messages"></div>
            <div style="position:fixed; bottom:56px; left:0; right:0; display:flex; background:#000; padding:10px; gap:8px;">
                <button id="attach-btn" style="background:none; border:none; color:var(--accent); font-size:20px;">ðŸ“Ž</button>
                <input type="text" id="chat-input" class="input-box" style="margin:0" placeholder="message...">
                <button id="send-btn" style="background:var(--accent); color:#fff; border:none; padding:10px 15px;">OK</button>
            </div>
        </section>
    </div>
    <nav class="bottom-nav"><div class="nav-btn active" onclick="switchTab('home')">accueil</div><div class="nav-btn" onclick="switchTab('chat')">chat</div></nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, doc, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyCv4nD9Nyez5ERGvW47q-6O-TA96zWJn0M", authDomain: "thinktalk-b3c85.firebaseapp.com", projectId: "thinktalk-b3c85", storageBucket: "thinktalk-b3c85.firebasestorage.app", messagingSenderId: "752141817301", appId: "1:752141817301:web:28fecaf81db27eb51d595c" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentUser = localStorage.getItem('tt_user'), curRoom = "gÃ©nÃ©ral", unsubChat = null, selectedMsgId = null;
    let targetX = null, targetY = null;

    // ANIMATION ENGINE
    const canvas = document.getElementById('canvas-dust'), ctx = canvas.getContext('2d');
    let particles = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize; resize();
    class P {
        constructor(){ this.init() }
        init(){ this.x = Math.random()*canvas.width; this.y = Math.random()*canvas.height; this.vx = (Math.random()-0.5); this.vy = (Math.random()-0.5); this.s = Math.random()*2; }
        update(){
            if(targetX){ this.x += (targetX - this.x)*0.08; this.y += (targetY - this.y)*0.08; }
            this.x += this.vx; this.y += this.vy;
            if(this.x<0||this.x>canvas.width) this.init();
        }
        draw(){ ctx.fillStyle="rgba(0,120,215,0.4)"; ctx.beginPath(); ctx.arc(this.x,this.y,this.s,0,7); ctx.fill(); }
    }
    for(let i=0;i<100;i++) particles.push(new P());
    function anim(){ ctx.clearRect(0,0,canvas.width,canvas.height); particles.forEach(p=>{p.update();p.draw()}); requestAnimationFrame(anim); } anim();

    // AUTH
    document.getElementById('btn-login').onclick = () => {
        const p = document.getElementById('auth-pseudo').value;
        if(p) { localStorage.setItem('tt_user', p); location.reload(); }
    };
    if(currentUser) { document.getElementById('auth-screen').style.display='none'; document.getElementById('main-app').style.display='flex'; enterRoom("gÃ©nÃ©ral"); }

    // ROOMS
    document.getElementById('btn-confirm-create').onclick = async () => {
        const n = document.getElementById('new-room-name').value, c = document.getElementById('new-room-code').value;
        if(n) { await addDoc(collection(db, "rooms"), { name: n, code: c || null }); closePopups(); }
    };

    onSnapshot(collection(db, "rooms"), (snap) => {
        const grid = document.getElementById('rooms-grid'); grid.innerHTML = "";
        snap.forEach(d => {
            const r = d.data();
            const tile = document.createElement('div'); tile.className = "tile tile-1x1";
            tile.innerHTML = `<span># ${r.name} ${r.code ? 'ðŸ”’' : ''}</span>`;
            tile.onclick = () => r.code ? askRoomCode(r) : enterRoom(r.name);
            grid.appendChild(tile);
        });
    });

    function askRoomCode(room) {
        document.getElementById('pop-room-auth').style.display='flex';
        document.getElementById('btn-room-enter').onclick = () => {
            if(document.getElementById('room-auth-input').value === room.code) { enterRoom(room.name); closePopups(); }
            else alert("Code erronÃ©");
        };
    }

    // CHAT & MEDIA
    window.enterRoom = (name) => {
        curRoom = name; document.getElementById('chat-header').innerText = "# " + name; switchTab('chat');
        if(unsubChat) unsubChat();
        unsubChat = onSnapshot(query(collection(db, "messages"), where("room", "==", name), orderBy("timestamp", "asc")), (snap) => {
            const box = document.getElementById('chat-messages'); box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data(), isImg = m.text.startsWith("data:image");
                const div = document.createElement('div'); div.className = "msg-block";
                const time = m.timestamp ? m.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";
                
                div.innerHTML = `
                    <div style="font-size:9px; color:var(--accent)">${m.sender}</div>
                    <div class="msg-content-wrapper">
                        <div class="msg-text">${isImg ? `<img src="${m.text}" class="msg-img">` : m.text}</div>
                        <div class="msg-info">${time}</div>
                    </div>`;

                // Logic: Click = Edit (Text) or Fullscreen (Img). Long Press = Delete.
                let timer;
                div.onmousedown = div.ontouchstart = (e) => {
                    timer = setTimeout(() => { if(m.sender === currentUser){ selectedMsgId = d.id; document.getElementById('pop-msg-options').style.display='flex'; }}, 700);
                };
                div.onmouseup = div.onmouseleave = div.ontouchend = () => clearTimeout(timer);
                
                div.onclick = (e) => {
                    if(isImg) {
                        targetX = e.clientX; targetY = e.clientY;
                        setTimeout(() => { 
                            document.getElementById('fullscreen-img').src = m.text;
                            document.getElementById('fullscreen-view').style.display='flex';
                            targetX = targetY = null;
                        }, 500);
                    } else if(m.sender === currentUser) {
                        selectedMsgId = d.id;
                        const val = prompt("Modifier :", m.text);
                        if(val) updateDoc(doc(db, "messages", d.id), { text: val });
                    }
                };
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    };

    const sendMedia = (file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const scale = Math.min(400 / img.width, 1);
                cvs.width = img.width * scale; cvs.height = img.height * scale;
                cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                addDoc(collection(db, "messages"), { text: cvs.toDataURL("image/jpeg", 0.5), sender: currentUser, room: curRoom, timestamp: serverTimestamp() });
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    };

    document.getElementById('send-btn').onclick = () => {
        const i = document.getElementById('chat-input');
        if(i.value) { addDoc(collection(db, "messages"), { text: i.value, sender: currentUser, room: curRoom, timestamp: serverTimestamp() }); i.value = ""; }
    };
    document.getElementById('attach-btn').onclick = () => document.getElementById('file-input').click();
    document.getElementById('file-input').onchange = (e) => { if(e.target.files[0]) sendMedia(e.target.files[0]); };
    document.getElementById('btn-msg-del').onclick = async () => { if(selectedMsgId){ await deleteDoc(doc(db, "messages", selectedMsgId)); closePopups(); }};

    window.switchTab = (t) => {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.getElementById('view-'+t).classList.add('active');
    };
    window.closePopups = () => document.querySelectorAll('.popup-overlay').forEach(p=>p.style.display='none');
    window.toggleMenu = () => { localStorage.clear(); location.reload(); };
</script>
</body>
</html>
