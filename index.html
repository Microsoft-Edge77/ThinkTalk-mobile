<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ThinkTalk Mobile v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
:root { --accent: #00a2e8; --bg: #000; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body, html { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; height: 100%; }

/* Structure Panorama */
#panorama { display: flex; width: 300vw; height: 100vh; transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); }
.view { width: 100vw; height: 100vh; padding: 25px 20px 80px 20px; display: flex; flex-direction: column; position: relative; }

/* Typo Metro */
.page-title { font-size: 13px; text-transform: uppercase; font-weight: 600; letter-spacing: 2px; margin-bottom: 5px; opacity: 0.7; }
.section-header { font-size: 55px; font-weight: 100; margin-bottom: 25px; color: var(--accent); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* Tuiles */
.tiles-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
.tile { background: var(--accent); aspect-ratio: 1/1; padding: 12px; display: flex; align-items: flex-end; font-size: 18px; font-weight: 600; cursor: pointer; border: none; color: white; }
.tile:active { transform: scale(0.95); opacity: 0.8; }

/* Listes (Contacts & Messages) */
.scroll-area { flex: 1; overflow-y: auto; padding-bottom: 20px; }
.list-item { padding: 15px 10px; border-bottom: 1px solid #222; font-size: 22px; font-weight: 300; }
.list-item:active { background: #111; color: var(--accent); }

.msg-bubble { margin-bottom: 15px; border-left: 3px solid var(--accent); padding-left: 12px; }
.msg-pseudo { color: var(--accent); font-size: 12px; font-weight: bold; }
.msg-text { font-size: 20px; line-height: 1.2; font-weight: 300; }

/* Inputs & Nav */
.input-bar { position: absolute; bottom: 15px; left: 15px; right: 15px; display: flex; gap: 8px; background: #000; }
input { background: #fff; border: none; padding: 12px; font-size: 16px; flex: 1; outline: none; }
.btn-sq { background: var(--accent); border: none; color: white; padding: 10px 20px; font-weight: bold; font-size: 14px; }

.nav-bottom { position: fixed; bottom: 0; width: 100%; height: 60px; background: #111; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; z-index: 100; }
.nav-item { font-size: 11px; text-transform: uppercase; color: #666; }
.nav-item.active { color: #fff; font-weight: bold; }

#auth { position: fixed; inset: 0; background: #000; z-index: 1000; padding: 40px 20px; }
.hidden { display: none !important; }
</style>
</head>
<body>

<div id="auth">
    <div class="page-title">THINKTALK</div>
    <h1 class="section-header">identification</h1>
    <input id="pseudo" type="text" placeholder="pseudo" style="width:100%; margin-bottom:10px;">
    <input id="code" type="password" placeholder="code (4-8 chiffres)" style="width:100%; margin-bottom:20px;">
    <button onclick="handleAuth('login')" class="btn-sq" style="width:100%; margin-bottom:10px;">SE CONNECTER</button>
    <button onclick="handleAuth('register')" class="btn-sq" style="width:100%; background:#222;">CRÉER UN COMPTE</button>
</div>

<div id="panorama">
    <div class="view" id="view-hub">
        <div class="page-title">THINKTALK</div>
        <h1 class="section-header">accueil</h1>
        <div class="tiles-container">
            <div class="tile" onclick="openRoom('general', 'room')">#general</div>
            <div class="tile" onclick="openRoom('gaming', 'room')">#gaming</div>
            <div class="tile" style="background:#333" onclick="goTo(2)">contacts</div>
            <div class="tile" style="background:#e81123" onclick="logout()">quitter</div>
        </div>
    </div>

    <div class="view" id="view-chat">
        <div class="page-title">DISCUTER</div>
        <h1 class="section-header" id="chat-title">salon</h1>
        <div id="message-container" class="scroll-area"></div>
        <div class="input-bar">
            <input id="msgInput" type="text" placeholder="répondre...">
            <button class="btn-sq" onclick="send()">ENVOYER</button>
        </div>
    </div>

    <div class="view" id="view-contacts">
        <div class="page-title">PERSONNES</div>
        <h1 class="section-header">contacts</h1>
        <div id="contacts-list" class="scroll-area"></div>
        <button onclick="addContactPrompt()" class="btn-sq" style="width:100%;">+ AJOUTER UN CONTACT</button>
    </div>
</div>

<div class="nav-bottom">
    <div class="nav-item active" onclick="goTo(0)">accueil</div>
    <div class="nav-item" onclick="goTo(1)">chat</div>
    <div class="nav-item" onclick="goTo(2)">contacts</div>
</div>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyCrgPMXzSyS6NXNajPxr0x_J-CTESOtp5w",
  authDomain: "chat-github-6abb5.firebaseapp.com",
  databaseURL: "https://chat-github-6abb5-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-github-6abb5",
  storageBucket: "chat-github-6abb5.firebasestorage.app",
  messagingSenderId: "1038562300660",
  appId: "1:1038562300660:web:b57b74a7539466e16384a1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let user = localStorage.getItem('tt_user');
let currentCtx = { id: 'general', type: 'room' };

// --- NAVIGATION ---
function goTo(index) {
    document.getElementById('panorama').style.transform = `translateX(-${index * 100}vw)`;
    const navs = document.querySelectorAll('.nav-item');
    navs.forEach((n, i) => n.classList.toggle('active', i === index));
}

// --- AUTHENTIFICATION SÉCURISÉE ---
async function handleAuth(type) {
    const p = document.getElementById('pseudo').value.trim();
    const c = document.getElementById('code').value.trim();
    if(!p || c.length < 4) return alert("Pseudo requis et code 4+ chiffres");

    const userRef = db.ref('users/' + p);
    const snap = await userRef.get();

    if(type === 'register') {
        if(snap.exists()) return alert("Ce pseudo est déjà utilisé !");
        await userRef.set({ code: c });
        alert("Compte créé !");
    } else {
        if(!snap.exists() || snap.val().code !== c) return alert("Pseudo ou code incorrect");
    }
    
    user = p;
    localStorage.setItem('tt_user', p);
    document.getElementById('auth').classList.add('hidden');
    loadContacts();
    openRoom('general', 'room');
}

// --- LOGIQUE CHAT (PUBLIC & PRIVÉ) ---
function openRoom(id, type) {
    currentCtx = { id: id, type: type };
    document.getElementById('chat-title').textContent = (type === 'room' ? '#' : '') + id;
    listenMessages();
    goTo(1);
}

function listenMessages() {
    let path = currentCtx.type === 'room' ? 'messages/public/' + currentCtx.id : 'messages/dm/' + getConvId(user, currentCtx.id);
    const ref = db.ref(path);
    const container = document.getElementById('message-container');
    ref.off();
    container.innerHTML = "";
    
    ref.limitToLast(30).on('child_added', snap => {
        const m = snap.val();
        const div = document.createElement('div');
        div.className = 'msg-bubble';
        div.innerHTML = `<div class="msg-pseudo">${m.pseudo}</div><div class="msg-text">${m.text}</div>`;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    });
}

function send() {
    const txt = document.getElementById('msgInput').value.trim();
    if(!txt) return;
    let path = currentCtx.type === 'room' ? 'messages/public/' + currentCtx.id : 'messages/dm/' + getConvId(user, currentCtx.id);
    db.ref(path).push({ pseudo: user, text: txt, timestamp: Date.now() });
    document.getElementById('msgInput').value = "";
}

// --- GESTION DES CONTACTS ---
async function loadContacts() {
    const list = document.getElementById('contacts-list');
    list.innerHTML = "";
    const snap = await db.ref('contacts/' + user).get();
    
    if(snap.exists()) {
        Object.keys(snap.val()).forEach(name => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.textContent = name;
            div.onclick = () => openRoom(name, 'dm');
            list.appendChild(div);
        });
    } else {
        list.innerHTML = "<p style='padding:20px; color:#666'>Aucun contact.</p>";
    }
}

async function addContactPrompt() {
    const target = prompt("Pseudo du contact à ajouter :");
    if(!target || target === user) return;

    // Vérifier si l'utilisateur existe
    const check = await db.ref('users/' + target).get();
    if(!check.exists()) return alert("Cet utilisateur n'existe pas.");

    // Ajouter mutuellement
    await db.ref(`contacts/${user}/${target}`).set(true);
    await db.ref(`contacts/${target}/${user}`).set(true);
    loadContacts();
    alert("Contact ajouté !");
}

// Utilitaires
function getConvId(a, b) { return [a, b].sort().join("__"); }
function logout() { localStorage.clear(); location.reload(); }

// Auto-login
if(user) { 
    document.getElementById('auth').classList.add('hidden');
    loadContacts();
    openRoom('general', 'room');
}
</script>
</body>
</html>
