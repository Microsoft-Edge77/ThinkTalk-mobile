<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ThinkTalk Mobile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --accent: #00a2e8; 
            --accent-glow: rgba(0, 162, 232, 0.3);
            --bg: #000; 
            --surface: #0a0a0a;
            --border: #222;
            --nav-h: 70px; 
            --chat-bar-h: 70px; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        html, body { 
            margin: 0; padding: 0; background: var(--bg); color: #fff; 
            font-family: 'Inter', sans-serif; height: 100%; width: 100%; overflow: hidden; 
        }

        #panorama { display: flex; width: 300vw; height: 100%; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); }

        .view { 
            width: 100vw; height: 100%; display: flex; flex-direction: column; 
            padding: 20px 20px 0 20px; position: relative; overflow: hidden; 
            background-color: var(--bg);
        }

        .scroll-container { flex: 1; overflow-y: auto; padding-bottom: 140px; scrollbar-width: none; }
        .scroll-container::-webkit-scrollbar { display: none; }

        .brand-header { 
            text-align: center; font-weight: 100; font-size: 14px; letter-spacing: 8px; 
            text-transform: uppercase; margin: 10px 0 30px 0; color: var(--accent); opacity: 0.9; 
        }

        .section-header { 
            font-size: 32px; font-weight: 100; margin: 5px 0 20px 0; 
            color: #fff; letter-spacing: -1px; text-transform: lowercase;
        }

        .page-title { font-size: 10px; text-transform: uppercase; font-weight: 600; letter-spacing: 4px; color: var(--accent); }

        /* TILES SYSTEM */
        .tiles-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            grid-auto-rows: 85px; 
            gap: 10px; 
            transition: 0.3s;
        }
        
        .tile { 
            background: var(--accent); padding: 12px; display: flex; flex-direction: column; 
            justify-content: flex-end; font-size: 13px; font-weight: 600; cursor: pointer; 
            transition: transform 0.2s, opacity 0.2s; border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            user-select: none;
        }

        .tile.dragging { opacity: 0.5; transform: scale(1.05); z-index: 10; }
        .tile.small { grid-column: span 1; grid-row: span 1; }
        .tile.medium { grid-column: span 2; grid-row: span 2; font-size: 16px; }
        .tile.wide { grid-column: span 4; grid-row: span 1; }
        
        .tile.contact { background: var(--surface); border: 1px solid var(--border); }

        /* EDIT MODE UI */
        .edit-mode .tile { animation: shake 0.3s infinite; }
        @keyframes shake {
            0% { transform: rotate(0.5deg); }
            50% { transform: rotate(-0.5deg); }
        }

        .resize-btn {
            position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5);
            border: 1px solid #fff; color: #fff; width: 24px; height: 24px;
            display: none; align-items: center; justify-content: center; font-size: 10px;
        }
        .edit-mode .resize-btn { display: flex; }

        /* UI ELEMENTS */
        .search-input { 
            width: 100%; padding: 15px; background: var(--surface); border: 1px solid var(--border); 
            color: #fff; font-family: 'Inter'; font-size: 14px; border-radius: 0;
        }

        .btn-top-action { 
            width: 100%; padding: 14px; background: transparent; border: 1px solid var(--accent); 
            color: var(--accent); font-weight: 600; font-size: 11px; letter-spacing: 2px; 
            text-transform: uppercase; cursor: pointer; margin-bottom: 15px;
        }

        .btn-edit-toggle {
            background: var(--surface); color: #fff; border: 1px solid var(--border);
            padding: 8px 15px; font-size: 10px; letter-spacing: 1px; cursor: pointer;
        }

        .nav-bottom { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-h); 
            background: rgba(0,0,0,0.95); display: flex; justify-content: space-around; 
            align-items: center; border-top: 1px solid var(--border); z-index: 100; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { font-size: 10px; letter-spacing: 1px; color: #444; font-weight: bold; }
        .nav-item.active { color: var(--accent); }

        #profile-menu { 
            position: fixed; inset: 0; width: 80%; background: #050505; z-index: 2000; 
            transform: translateX(-100%); transition: 0.4s; padding: 60px 30px; border-right: 1px solid var(--accent);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="notification">SYSTÈME : PRÊT</div>

<div id="profile-menu">
    <div class="page-title" style="margin-bottom: 10px;">Compte</div>
    <h2 id="me-pseudo" class="section-header">pseudo</h2>
    <div onclick="uiChangeWallpaper()" style="padding:15px 0; color:var(--accent); cursor:pointer;">Fond d'écran</div>
    <div onclick="logout()" style="padding:15px 0; color:#ff3b3b; cursor:pointer;">Déconnexion</div>
    <button onclick="toggleMenu()" class="btn-top-action" style="margin-top: 60px;">FERMER</button>
</div>

<div id="auth">
    <div class="brand-header">THINKTALK</div>
    <h1 class="section-header" style="text-align: center;">bienvenue.</h1>
    <input id="authPseudo" class="search-input" placeholder="Pseudo" style="margin-bottom: 10px;">
    <input id="authCode" type="password" class="search-input" placeholder="Code" style="margin-bottom: 25px;">
    <button onclick="handleAuth('login')" class="btn-top-action" style="background: var(--accent); color: #fff;">S'IDENTIFIER</button>
</div>

<div id="panorama">
    <section class="view">
        <div class="scroll-container">
            <div class="brand-header">ThinkTalk</div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h1 class="section-header" style="margin:0;">salons</h1>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn-edit-toggle" onclick="toggleEditMode()">MODIFIER</button>
                    <div style="font-size: 20px; color: var(--accent); cursor: pointer;" onclick="toggleMenu()">☰</div>
                </div>
            </div>
            
            <button onclick="uiCreateRoom()" class="btn-top-action">+ NOUVEAU CANAL</button>
            <input type="text" id="roomSearch" class="search-input" style="margin-bottom: 20px;" placeholder="Rechercher..." oninput="filterRooms()">

            <div id="rooms-grid" class="tiles-grid"></div>
        </div>
    </section>

    <section class="view view-chat" style="background-size:cover; background-position:center;">
        <div class="page-title">Canal Actif</div>
        <h1 class="section-header" id="chat-title">chat</h1>
        <div id="empty-chat-state" style="flex: 1; display: flex; align-items: center; justify-content: center; opacity: 0.3; font-size: 12px;">SÉLECTIONNEZ UN SALON</div>
        <div id="message-container" class="scroll-container" style="display:none; padding-bottom: 180px;"></div>
    </section>

    <section class="view">
        <div class="scroll-container">
            <div class="page-title">Réseau</div>
            <h1 class="section-header">contacts</h1>
            <button onclick="uiAddContact()" class="btn-top-action">+ AJOUTER UN CONTACT</button>
            <div id="contacts-grid" class="tiles-grid"></div>
        </div>
    </section>
</div>

<div id="chat-bar" style="position: fixed; bottom: var(--nav-h); left: 0; width: 100%; height: var(--chat-bar-h); padding: 10px; background: rgba(10,10,10,0.95); display: none; gap: 8px; border-top: 1px solid var(--border); z-index: 101;">
    <input id="msgInput" type="text" placeholder="Message..." style="flex: 1; background: #000; border: 1px solid var(--border); color: #fff; padding: 0 15px;">
    <button onclick="sendMessage()" style="padding:0 20px; background:var(--accent); border:none; color:#fff; font-weight: bold;">OK</button>
</div>

<nav class="nav-bottom">
    <div class="nav-item active" onclick="goTo(0)">SALONS</div>
    <div class="nav-item" onclick="goTo(1)">CHAT</div>
    <div class="nav-item" onclick="goTo(2)">CONTACTS</div>
</nav>

<script>
// CONFIG FIREBASE (Garde tes infos)
const firebaseConfig = {
    apiKey: "AIzaSyCrgPMXzSyS6NXNajPxr0x_J-CTESOtp5w",
    authDomain: "chat-github-6abb5.firebaseapp.com",
    databaseURL: "https://chat-github-6abb5-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "chat-github-6abb5",
    storageBucket: "chat-github-6abb5.firebasedatabase.app",
    messagingSenderId: "1038562300660",
    appId: "1:1038562300660:web:b57b74a7539466e16384a1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let user = localStorage.getItem("thinktalk_pseudo");
let isEditMode = false;
let allRooms = [];
let currentCtx = null;

// GESTION DU MODE ÉDITION ET DRAG & DROP
function toggleEditMode() {
    isEditMode = !isEditMode;
    document.getElementById('rooms-grid').classList.toggle('edit-mode', isEditMode);
    document.querySelector('.btn-edit-toggle').textContent = isEditMode ? "TERMINER" : "MODIFIER";
    if(!isEditMode) saveTileLayout();
}

function renderRooms(roomsList) {
    const grid = document.getElementById('rooms-grid');
    grid.innerHTML = "";
    
    // Charger les tailles sauvegardées
    const savedSizes = JSON.parse(localStorage.getItem('tile_sizes') || '{}');

    roomsList.forEach((r, i) => {
        const tile = document.createElement('div');
        tile.className = 'tile ' + (savedSizes[r.name] || 'small');
        tile.setAttribute('draggable', isEditMode);
        tile.id = `tile-${r.name}`;
        
        tile.innerHTML = `
            <span>#${r.name}</span>
            <div class="resize-btn" onclick="resizeTile(event, '${r.name}')">↗</div>
        `;

        tile.onclick = () => { if(!isEditMode) selectRoom(r, r.name); };
        
        // Drag & Drop Events
        tile.ondragstart = (e) => { if(isEditMode) e.target.classList.add('dragging'); };
        tile.ondragend = (e) => { e.target.classList.remove('dragging'); };
        
        grid.appendChild(tile);
    });

    grid.ondragover = (e) => {
        e.preventDefault();
        if(!isEditMode) return;
        const dragging = document.querySelector('.dragging');
        const afterElement = getDragAfterElement(grid, e.clientY);
        if (afterElement == null) {
            grid.appendChild(dragging);
        } else {
            grid.insertBefore(dragging, afterElement);
        }
    };
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.tile:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function resizeTile(event, roomName) {
    event.stopPropagation();
    const tile = document.getElementById(`tile-${roomName}`);
    const sizes = ['small', 'medium', 'wide'];
    let current = sizes.find(s => tile.classList.contains(s)) || 'small';
    let next = sizes[(sizes.indexOf(current) + 1) % sizes.length];
    
    tile.classList.remove(...sizes);
    tile.classList.add(next);
    
    // Sauvegarde immédiate de la taille
    const savedSizes = JSON.parse(localStorage.getItem('tile_sizes') || '{}');
    savedSizes[roomName] = next;
    localStorage.setItem('tile_sizes', JSON.stringify(savedSizes));
}

function saveTileLayout() {
    // Ici tu pourrais sauvegarder l'ordre des IDs dans le localStorage si tu veux garder l'ordre après refresh
    showNotify("SYSTÈME : MISE EN PAGE SAUVÉE");
}

// NAVIGATION & AUTH (Tes fonctions existantes adaptées)
function goTo(index) {
    document.getElementById('panorama').style.transform = `translateX(-${index * 100}vw)`;
    document.querySelectorAll('.nav-item').forEach((n, i) => n.classList.toggle('active', i === index));
    document.getElementById('chat-bar').style.display = (index === 1 && currentCtx) ? 'flex' : 'none';
}

function selectRoom(roomData, roomName) {
    currentCtx = { id: roomName, type: 'room' };
    document.getElementById('chat-title').textContent = "#" + roomName;
    document.getElementById('empty-chat-state').style.display = 'none';
    document.getElementById('message-container').style.display = 'block';
    goTo(1);
    // Ici : Ajouter ta fonction listenMessages()
}

function loadRooms() {
    db.ref("rooms").on('value', snap => {
        allRooms = [];
        snap.forEach(child => {
            const r = child.val();
            allRooms.push({ name: r.name || child.key, ...r });
        });
        renderRooms(allRooms);
    });
}

async function handleAuth(type) {
    const p = document.getElementById('authPseudo').value.trim();
    if(!p) return;
    user = p;
    localStorage.setItem("thinktalk_pseudo", p);
    startApp();
}

function startApp() {
    document.getElementById('auth').classList.add('hidden');
    document.getElementById('me-pseudo').textContent = user;
    loadRooms();
}

function showNotify(msg) {
    const n = document.getElementById('notification');
    n.textContent = msg; n.style.display = 'block';
    setTimeout(() => n.style.display = 'none', 2000);
}

window.onload = () => { if(user) startApp(); };
</script>
</body>
</html>
