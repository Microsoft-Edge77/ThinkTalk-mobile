<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ThinkTalk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        :root { --accent: #00a2e8; --bg: #000; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; background-position: center; background-size: cover; background-attachment: fixed; }
        
        /* LOGO DYNAMIQUE */
        .logo-container {
            width: 50px; height: 50px; background: #000; border: 2px solid var(--accent);
            display: flex; align-items: center; justify-content: center; margin-bottom: 15px;
        }
        .logo-container svg { width: 30px; height: 30px; stroke: var(--accent); fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        /* ECRAN DE CONNEXION */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center;
            background-size: cover; background-position: center;
        }
        .auth-container {
            width: 90%; max-width: 320px; padding: 30px;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            border: 1px solid #222; text-align: center;
        }
        .auth-container .logo-container { margin: 0 auto 20px auto; }
        .auth-container h1 { font-weight: 100; font-size: 32px; color: var(--accent); margin-bottom: 25px; text-transform: uppercase; }
        .auth-container input {
            width: 100%; padding: 12px; background: #111; border: 1px solid #333;
            color: #fff; margin-bottom: 10px; outline: none; transition: 0.3s;
        }
        .auth-container input:focus { border-color: var(--accent); }
        .auth-btn {
            width: 100%; padding: 12px; background: var(--accent); border: none;
            color: #fff; font-weight: bold; cursor: pointer; margin-top: 5px; text-transform: uppercase;
        }
        .auth-btn.secondary { background: transparent; border: 1px solid #444; margin-top: 10px; }

        /* LAYOUT PC */
        #pc-layout { display: none; height: 100vh; }
        #sidebar { width: 280px; border-right: 1px solid #222; padding: 15px; display: flex; flex-direction: column; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); }
        .pc-tabs { display: flex; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .pc-tab { font-size: 12px; font-weight: bold; cursor: pointer; color: #555; text-transform: uppercase; }
        .pc-tab.active { color: #fff; border-bottom: 2px solid var(--accent); }

        .msg-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 15px; }
        .msg { background: rgba(255,255,255,0.07); padding: 10px; border-left: 4px solid #333; width: fit-content; max-width: 90%; align-self: flex-start; }
        .msg.mine { border-left-color: var(--accent); }
        .msg-header { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 5px; color: var(--accent); font-weight: bold; gap: 20px; }

        .tiles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .tile { background: var(--accent); padding: 12px; height: 110px; display: flex; flex-direction: column; justify-content: flex-end; font-weight: bold; cursor: pointer; position: relative; overflow: hidden; }
        .tile.contact { background: #333; }
        .live-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 10px; background: inherit; display: flex; flex-direction: column; font-size: 11px; font-weight: normal; z-index: 1; }

        .search-bar { width: 100%; padding: 10px; background: #111; border: 1px solid #333; color: #fff; outline: none; margin-bottom: 10px; font-size: 13px; }
        .search-bar:focus { border-color: var(--accent); }

        .input-area { display: flex; padding: 10px; background: #000; border-top: 1px solid #222; }
        .input-area input { flex: 1; padding: 12px; background: #111; border: 1px solid #333; color: #fff; outline: none; }
        .btn-send { background: var(--accent); border: none; color: #fff; padding: 12px 20px; cursor: pointer; font-weight: bold; }

        .btn-action-metro { padding: 10px; font-size: 11px; background: rgba(255,255,255,0.05); color: #fff; border: 1px solid #333; cursor: pointer; text-align: left; text-transform: uppercase; margin-bottom: 5px; width: 100%; }

        /* MOBILE */
        #mobile-layout { display: none; height: 100vh; padding-top: 60px; }
        .mobile-header { position: fixed; top: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 900; border-bottom: 1px solid #222; }
        #panorama { display: flex; width: 300vw; height: 100%; transition: transform 0.6s cubic-bezier(0.1, 0.7, 0.1, 1); }
        .view { width: 100vw; height: 100%; padding: 15px; overflow-y: auto; padding-bottom: 150px; }
        .nav-bottom { position: fixed; bottom: 0; width: 100%; height: 70px; background: #000; border-top: 1px solid #222; display: flex; }
        .nav-btn { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #555; }
        .nav-btn.active { color: #fff; border-bottom: 3px solid var(--accent); }

        @media (min-width: 851px) { #pc-layout { display: flex; } }
        @media (max-width: 850px) { #mobile-layout { display: block; } }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-container">
            <div class="logo-container">
                <svg viewBox="0 0 24 24"><path d="M6 7.91V16a6 6 0 0 0 6 6 6 6 0 0 0 6-6V6a4 4 0 0 0-4-4 4 4 0 0 0-4 4v10a2 2 0 0 0 2 2 2 2 0 0 0 2-2V7.91"></path></svg>
            </div>
            <h1>ThinkTalk</h1>
            <input type="text" id="auth-pseudo" placeholder="Pseudo">
            <input type="password" id="auth-code" placeholder="Code secret">
            <button class="auth-btn" onclick="handleAuth('login')">Se connecter</button>
            <button class="auth-btn secondary" onclick="handleAuth('signup')">Créer un compte</button>
        </div>
    </div>

    <input type="file" id="bg-selector-hidden" style="display:none" accept="image/*" onchange="processLocalBg(this)">

    <div id="pc-layout">
        <aside id="sidebar">
            <div class="logo-container">
                <svg viewBox="0 0 24 24"><path d="M6 7.91V16a6 6 0 0 0 6 6 6 6 0 0 0 6-6V6a4 4 0 0 0-4-4 4 4 0 0 0-4 4v10a2 2 0 0 0 2 2 2 2 0 0 0 2-2V7.91"></path></svg>
            </div>
            <button class="btn-action-metro" onclick="document.getElementById('bg-selector-hidden').click()">Changer le fond</button>
            <button class="btn-action-metro" onclick="resetBg()" style="color:#ff4d4d; border-color:#500; margin-bottom:15px;">Reset fond</button>
            
            <div class="pc-tabs">
                <div class="pc-tab active" id="tab-pc-rooms" onclick="switchPcTab('rooms')">Salons</div>
                <div class="pc-tab" id="tab-pc-contacts" onclick="switchPcTab('contacts')">Contacts</div>
            </div>

            <div id="pc-contact-tools" style="display:none;">
                <input type="text" class="search-bar" placeholder="Rechercher contact..." oninput="filterContacts(this.value)">
                <button class="btn-action-metro" style="border-color: var(--accent); color: var(--accent);" onclick="alert('Fonctionnalité d\'ajout bientôt disponible')">+ AJOUTER UN CONTACT</button>
            </div>

            <div id="pc-content-list" style="flex:1; overflow-y:auto; margin-top:10px;"></div>
            <button onclick="logout()" style="color:red; background:none; border:none; cursor:pointer; text-align:left; font-size:11px; margin-top:10px;">DÉCONNEXION</button>
        </aside>
        <main style="flex:1; display:flex; flex-direction:column;">
            <div style="padding:20px; border-bottom:1px solid #222;"><h2 id="chat-title-pc" style="font-weight:100;">#accueil</h2></div>
            <div id="msg-pc" class="msg-list"></div>
            <div class="input-area">
                <input type="text" id="in-pc" placeholder="Écrire..." onkeypress="if(event.key==='Enter') send('pc')">
                <button class="btn-send" onclick="send('pc')">ENVOYER</button>
            </div>
        </main>
    </div>

    <div id="mobile-layout">
        <div class="mobile-header">
            <div class="logo-container" style="width:35px; height:35px; margin-bottom:0; border-width:1px;">
                <svg viewBox="0 0 24 24" style="width:20px; height:20px;"><path d="M6 7.91V16a6 6 0 0 0 6 6 6 6 0 0 0 6-6V6a4 4 0 0 0-4-4 4 4 0 0 0-4 4v10a2 2 0 0 0 2 2 2 2 0 0 0 2-2V7.91"></path></svg>
            </div>
            <span onclick="logout()" style="color:red; font-size:12px">SORTIR</span>
        </div>
        <div id="panorama">
            <section class="view">
                <h1 style="font-size:40px; font-weight:100; color:var(--accent); margin-bottom:20px;">salons</h1>
                <div id="mob-rooms" class="tiles-grid"></div>
            </section>
            <section class="view">
                <h2 id="chat-title-mob" style="font-weight:100; margin-bottom:10px;">Chat</h2>
                <div id="msg-mob" class="msg-list"></div>
            </section>
            <section class="view">
                <h1 style="font-size:40px; font-weight:100; color:var(--accent); margin-bottom:20px;">contacts</h1>
                <input type="text" class="search-bar" placeholder="Rechercher..." oninput="filterContacts(this.value)">
                <div id="mob-contacts" class="tiles-grid"></div>
            </section>
        </div>
        <div class="input-area" id="mob-bar" style="display:none; position:fixed; bottom:70px; width:100%;">
            <input type="text" id="in-mob" placeholder="Message..." onkeypress="if(event.key==='Enter') send('mob')">
            <button class="btn-send" onclick="send('mob')">OK</button>
        </div>
        <nav class="nav-bottom">
            <div class="nav-btn active" onclick="goTo(0)">ACCUEIL</div>
            <div class="nav-btn" onclick="goTo(1)">CHAT</div>
            <div class="nav-btn" onclick="goTo(2)">CONTACTS</div>
        </nav>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCrgPMXzSyS6NXNajPxr0x_J-CTESOtp5w",
            authDomain: "chat-github-6abb5.firebaseapp.com",
            databaseURL: "https://chat-github-6abb5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chat-github-6abb5",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let user = localStorage.getItem("thinktalk_pseudo");
        let current = { id: 'general', type: 'room' };
        let activePcTab = 'rooms';

        function handleAuth(type) {
            const pseudo = document.getElementById('auth-pseudo').value.trim().toLowerCase();
            const code = document.getElementById('auth-code').value.trim();
            if(!pseudo || !code) return alert("Remplissez tout !");
            db.ref('users/' + pseudo).get().then(s => {
                if(type === 'login') {
                    if(s.exists() && s.val().code === code) loginSuccess(pseudo);
                    else alert("Pseudo ou code incorrect");
                } else {
                    if(s.exists()) alert("Ce pseudo existe déjà");
                    else if(code.length < 4) alert("Code trop court (4 min)");
                    else db.ref('users/' + pseudo).set({ code: code }).then(() => loginSuccess(pseudo));
                }
            });
        }

        function loginSuccess(pseudo) {
            user = pseudo;
            localStorage.setItem("thinktalk_pseudo", user);
            document.getElementById('auth-screen').style.display = 'none';
            startApp();
        }

        function startApp() {
            initBg();
            loadLists();
            setChat('general', 'room');
        }

        function processLocalBg(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                localStorage.setItem("thinktalk_bg", e.target.result);
                initBg();
            };
            reader.readAsDataURL(file);
        }

        function resetBg() {
            localStorage.removeItem("thinktalk_bg");
            initBg();
        }

        function initBg() {
            const bg = localStorage.getItem("thinktalk_bg");
            const target = bg ? `url('${bg}')` : "none";
            document.body.style.backgroundImage = target;
            document.getElementById('auth-screen').style.backgroundImage = target;
            if(!bg) document.body.style.backgroundColor = "#000";
        }

        function bindLiveTile(id, type, element) {
            const path = type === 'room' ? `messages/public/${id}` : `messages/dm/${[user, id].sort().join("__")}`;
            db.ref(path).limitToLast(1).on('value', snap => {
                if(!snap.exists()) return;
                const m = Object.values(snap.val())[0];
                let preview = element.querySelector('.live-preview');
                if(!preview) { preview = document.createElement('div'); preview.className = 'live-preview'; element.appendChild(preview); }
                preview.innerHTML = `<b>${m.pseudo}</b><div style="font-size:10px; opacity:0.8; overflow:hidden;">${m.text}</div>`;
            });
        }

        function loadLists() {
            // Salons
            db.ref("rooms").on('value', s => {
                const mb = document.getElementById('mob-rooms'), pc = document.getElementById('pc-content-list');
                if(mb) mb.innerHTML = ""; if(pc && activePcTab==='rooms') pc.innerHTML = "";
                const addR = (id) => {
                    const t = document.createElement('div'); t.className = "tile"; t.innerHTML = "# "+id;
                    t.onclick = () => { setChat(id, 'room'); goTo(1); }; if(mb) mb.appendChild(t);
                    bindLiveTile(id, 'room', t);
                    if(pc && activePcTab==='rooms'){ const b=document.createElement('button'); b.className="btn-action-metro"; b.textContent="# "+id; b.onclick=()=>setChat(id,'room'); pc.appendChild(b); }
                };
                addR('general');
                s.forEach(r => { if(r.key!=='general') addR(r.key); });
            });
            // Contacts
            db.ref("users").on('value', s => {
                const mc = document.getElementById('mob-contacts'), pc = document.getElementById('pc-content-list');
                if(mc) mc.innerHTML = ""; if(pc && activePcTab==='contacts') pc.innerHTML = "";
                s.forEach(c => {
                    if(c.key === user.toLowerCase()) return;
                    const t = document.createElement('div'); t.className="tile contact"; t.setAttribute('data-id', c.key); t.innerHTML = c.key;
                    t.onclick=()=>{ setChat(c.key,'dm'); if(window.innerWidth <= 850) goTo(1); }; if(mc) mc.appendChild(t);
                    bindLiveTile(c.key, 'dm', t);
                    if(pc && activePcTab==='contacts'){ const b=document.createElement('button'); b.className="btn-action-metro"; b.setAttribute('data-id', c.key); b.textContent="@ "+c.key; b.onclick=()=>setChat(c.key,'dm'); pc.appendChild(b); }
                });
            });
        }

        function setChat(id, type) {
            current = { id, type };
            document.getElementById('chat-title-pc').textContent = (type==='room'?'# ':'@ ')+id;
            document.getElementById('chat-title-mob').textContent = (type==='room'?'# ':'@ ')+id;
            const path = type === 'room' ? `messages/public/${id}` : `messages/dm/${[user, id].sort().join("__")}`;
            db.ref(path).off();
            db.ref(path).on('value', s => {
                const pc = document.getElementById('msg-pc'), mb = document.getElementById('msg-mob');
                if(pc) pc.innerHTML = ""; if(mb) mb.innerHTML = "";
                s.forEach(snap => {
                    const m = snap.val();
                    const html = `<div class="msg ${m.pseudo===user?'mine':''}">
                        <div class="msg-header"><span>${m.pseudo}</span><span>${m.time||''}</span></div>
                        <div class="msg-text">${m.text}</div>
                    </div>`;
                    if(pc) pc.insertAdjacentHTML('beforeend', html); if(mb) mb.insertAdjacentHTML('beforeend', html);
                });
                if(pc) pc.scrollTop = pc.scrollHeight; if(mb) mb.scrollTop = mb.scrollHeight;
            });
        }

        function send(m) {
            const i = document.getElementById(m==='pc'?'in-pc':'in-mob');
            const v = i.value.trim();
            if(!v) return;
            const path = current.type === 'room' ? `messages/public/${current.id}` : `messages/dm/${[user, current.id].sort().join("__")}`;
            db.ref(path).push({ pseudo: user, text: v, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
            i.value = "";
        }

        function switchPcTab(t) { 
            activePcTab = t; 
            document.getElementById('tab-pc-rooms').classList.toggle('active', t==='rooms');
            document.getElementById('tab-pc-contacts').classList.toggle('active', t==='contacts');
            document.getElementById('pc-contact-tools').style.display = (t==='contacts') ? 'block' : 'none';
            loadLists(); 
        }

        function goTo(x) { 
            document.getElementById('panorama').style.transform = `translateX(-${x*100}vw)`; 
            document.querySelectorAll('.nav-btn').forEach((b,i) => b.classList.toggle('active', i===x)); 
            document.getElementById('mob-bar').style.display = (x===1) ? 'flex' : 'none'; 
        }

        function filterContacts(q) {
            const query = q.toLowerCase();
            // Filtre Mobile
            document.querySelectorAll('#mob-contacts .tile').forEach(t => t.style.display = t.getAttribute('data-id').includes(query) ? 'flex' : 'none');
            // Filtre PC
            document.querySelectorAll('#pc-content-list .btn-action-metro').forEach(b => {
                const id = b.getAttribute('data-id');
                if(id) b.style.display = id.includes(query) ? 'block' : 'none';
            });
        }

        window.onload = () => { if(user) { document.getElementById('auth-screen').style.display='none'; startApp(); } else { initBg(); } }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
