<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ThinkTalk OS - Infinity</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        :root { --accent: #00a2e8; --bg-img: none; --depth: perspective(1000px); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: #000; color: #fff; height: 100vh; overflow: hidden; 
            background-image: var(--bg-img); background-size: cover; background-position: center;
        }

        /* --- ANIMATIONS "METRO" --- */
        @keyframes pageTurn { from { transform: rotateY(-90deg); opacity: 0; } to { transform: rotateY(0deg); opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(100px) rotateX(-30deg); opacity: 0; } to { transform: translateY(0) rotateX(0); opacity: 1; } }
        
        .animate-turnstile { animation: pageTurn 0.6s cubic-bezier(0.1, 0.9, 0.2, 1) forwards; transform-origin: left; }
        .animate-msg { animation: slideInUp 0.4s cubic-bezier(0.1, 0.8, 0.2, 1) forwards; }

        /* --- TUILES VIVANTES --- */
        .tiles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; padding: 15px; }
        .tile { 
            background: var(--accent); padding: 15px; height: 140px; position: relative;
            cursor: pointer; transition: 0.3s; overflow: hidden; display: flex; align-items: flex-end;
            transform-style: preserve-3d;
        }
        .live-preview { position: absolute; top: 12px; left: 12px; font-size: 11px; opacity: 0.8; font-weight: 300; }

        /* --- MESSAGES : ALIGNÃ‰S Ã€ GAUCHE --- */
        .msg-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg { 
            background: #1a1a1a; padding: 12px 18px; border-left: 4px solid var(--accent); 
            align-self: flex-start; max-width: 85%; position: relative;
        }
        .msg-author { font-size: 10px; color: var(--accent); font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }

        /* --- NAVIGATION --- */
        .nav-bar { 
            position: fixed; bottom: 0; width: 100%; height: 70px; background: rgba(0,0,0,0.9); 
            backdrop-filter: blur(10px); border-top: 1px solid #333; display: flex; justify-content: space-around; align-items: center; z-index: 100;
        }
        .nav-item { font-size: 11px; font-weight: bold; color: #555; cursor: pointer; text-transform: uppercase; }
        .nav-item.active { color: #fff; text-shadow: 0 0 10px var(--accent); }

        /* --- PC SIDEBAR FIX --- */
        #pc-layout { display: none; height: 100vh; }
        #sidebar { width: 340px; background: rgba(0,0,0,0.95); border-right: 1px solid #222; display: flex; flex-direction: column; padding: 30px; z-index: 50; height: 100vh; }
        .pc-scroll-area { overflow-y: auto; flex: 1; margin-bottom: 20px; }
        .pc-item { padding: 12px 18px; background: rgba(255,255,255,0.03); margin-bottom: 6px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .pc-item:hover { background: var(--accent); }

        /* --- INPUT AREA --- */
        .input-area { display: flex; background: #000; padding: 18px; gap: 15px; border-top: 1px solid #222; align-items: center; }
        .input-area input { flex: 1; background: #111; border: 2px solid #333; color: #fff; padding: 12px; outline: none; }

        /* --- MODALS --- */
        #settings-panel { 
            position: fixed; top: 0; left: -100%; width: 320px; height: 100%; 
            background: #000; z-index: 1000; transition: 0.5s; padding: 40px; border-right: 4px solid var(--accent);
        }
        #settings-panel.open { left: 0; }
        #metro-dialog { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .dialog-box { background: #000; border: 2px solid var(--accent); width: 90%; max-width: 420px; padding: 40px; }
        .color-dot { width: 35px; height: 35px; cursor: pointer; display: inline-block; margin: 6px; }

        @media (min-width: 851px) { #pc-layout { display: flex; } }
        @media (max-width: 850px) { #mobile-layout { display: block; } }
        
        /* --- MOBILE VIEW FIX --- */
        .view { width: 100vw; height: 100vh; background: #000; flex-shrink: 0; overflow-y: auto; }
    </style>
</head>
<body>

    <audio id="notif-sound" src="https://actions.google.com/sounds/v1/foley/drawbridge_clink.ogg"></audio>

    <div id="settings-panel">
        <h2 style="font-weight:100; font-size:50px; margin-bottom:40px;">paramÃ¨tres</h2>
        <div id="color-picker"></div>
        <button onclick="changeBg()" style="width:100%; padding:15px; margin-top:30px; background:#111; color:white; border:1px solid #333; cursor:pointer;">Changer fond d'Ã©cran</button>
        <button onclick="logout()" style="width:100%; padding:15px; margin-top:10px; background:#e51400; color:white; border:none; cursor:pointer; font-weight:bold;">DÃ©connexion</button>
        <button onclick="toggleMenu()" style="margin-top:60px; background:none; border:1px solid #fff; color:white; padding:12px 30px; cursor:pointer; width:100%;">RETOUR</button>
    </div>

    <div id="metro-dialog">
        <div class="dialog-box">
            <h2 id="dialog-title" style="font-weight:100; margin-bottom:20px; font-size:32px;"></h2>
            <div id="dialog-body"></div>
            <div style="margin-top:40px; display:flex; gap:12px;">
                <button onclick="closeDialog()" style="flex:1; padding:15px; background:none; border:1px solid #fff; color:#fff; cursor:pointer;">ANNULER</button>
                <button id="dialog-confirm" style="flex:1; padding:15px; background:var(--accent); border:none; color:#fff; font-weight:bold; cursor:pointer;">OK</button>
            </div>
        </div>
    </div>

    <div id="pc-layout">
        <aside id="sidebar">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
                <h1 style="font-weight:100; font-size:38px; letter-spacing:-2px;">ThinkTalk</h1>
                <span onclick="toggleMenu()" style="cursor:pointer; font-size:32px; padding:10px;">â‰¡</span>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button onclick="openCreateRoom()" style="flex:1; padding:10px; background:var(--accent); border:none; color:white; font-weight:bold;">+ SALON</button>
                <button onclick="joinPrivateRoom()" style="flex:1; padding:10px; background:#111; color:var(--accent); border:1px solid var(--accent);">ðŸ”‘ PRIVÃ‰</button>
            </div>
            <p style="color:var(--accent); font-size:11px; font-weight:bold; margin-bottom:10px;">SALONS</p>
            <div id="pc-rooms" class="pc-scroll-area"></div>
            <p style="color:var(--accent); font-size:11px; font-weight:bold; margin-bottom:10px;">CONTACTS</p>
            <div id="pc-contacts" class="pc-scroll-area"></div>
        </aside>
        <main style="flex:1; display:flex; flex-direction:column; background: rgba(0,0,0,0.6);">
            <div id="msg-pc" class="msg-list"></div>
            <div class="input-area">
                <input type="file" id="file-pc" hidden onchange="handleFile(this)">
                <span onclick="document.getElementById('file-pc').click()" style="cursor:pointer; font-size:28px; color:var(--accent);">ðŸ“Ž</span>
                <input type="text" id="in-pc" placeholder="Message..." onkeypress="if(event.key==='Enter') send('pc')">
                <button onclick="send('pc')" style="background:var(--accent); border:none; padding:15px 30px; color:white; font-weight:bold; cursor:pointer;">ENVOYER</button>
            </div>
        </main>
    </div>

    <div id="mobile-layout" style="display:none;">
        <div style="position:absolute; top:0; width:100%; padding:20px; display:flex; justify-content:space-between; align-items:center; z-index:10; background:black;">
            <span style="font-weight:100; letter-spacing:4px; font-size:12px;">THINKTALK</span>
            <span onclick="toggleMenu()" style="font-size:30px;">â‰¡</span>
        </div>
        <div id="panorama" style="display:flex; width:300vw; transition:0.7s cubic-bezier(0.1, 0.9, 0.1, 1);">
            <section class="view">
                <h1 style="font-size:55px; font-weight:100; margin:80px 20px 20px;">salons</h1>
                <div id="mob-rooms" class="tiles-grid"></div>
            </section>
            <section class="view" style="display:flex; flex-direction:column;">
                <h1 id="mob-title" style="font-size:35px; font-weight:100; margin:80px 25px 10px;">#accueil</h1>
                <div id="msg-mob" class="msg-list" style="margin-bottom:140px;"></div>
                <div class="input-area" id="mob-input-bar" style="display:none; position:fixed; bottom:70px; width:100%;">
                    <input type="file" id="file-mob" hidden onchange="handleFile(this)">
                    <span onclick="document.getElementById('file-mob').click()" style="font-size:24px; color:var(--accent); padding:0 15px;">ðŸ“Ž</span>
                    <input type="text" id="in-mob" placeholder="RÃ©pondre..." onkeypress="if(event.key==='Enter') send('mob')">
                    <button onclick="send('mob')" style="background:var(--accent); border:none; color:white; padding:12px 20px; font-weight:bold;">OK</button>
                </div>
            </section>
            <section class="view">
                <h1 style="font-size:55px; font-weight:100; margin:80px 20px 20px;">contacts</h1>
                <div id="mob-contacts" class="tiles-grid"></div>
            </section>
        </div>
        <nav class="nav-bar">
            <div class="nav-item active" onclick="goTo(0)">SALONS</div>
            <div class="nav-item" onclick="goTo(1)">CHAT</div>
            <div class="nav-item" onclick="goTo(2)">CONTACTS</div>
        </nav>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCrgPMXzSyS6NXNajPxr0x_J-CTESOtp5w", authDomain: "chat-github-6abb5.firebaseapp.com", databaseURL: "https://chat-github-6abb5-default-rtdb.europe-west1.firebasedatabase.app", projectId: "chat-github-6abb5" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let user = localStorage.getItem("tt_user"), current = { id: 'general', type: 'room' };

        function toggleMenu() { document.getElementById('settings-panel').classList.toggle('open'); }
        function closeDialog() { document.getElementById('metro-dialog').style.display = 'none'; }
        function openDialog(title, body, confirm) {
            document.getElementById('metro-dialog').style.display = 'flex';
            document.getElementById('dialog-title').textContent = title;
            document.getElementById('dialog-body').innerHTML = body;
            document.getElementById('dialog-confirm').onclick = () => { confirm(); closeDialog(); };
        }

        function setChat(id, type) {
            current = { id, type };
            const path = type === 'room' ? `messages/public/${id}` : `messages/dm/${[user,id].sort().join("__")}`;
            db.ref(path).off();
            db.ref(path).on('value', s => {
                const pc = document.getElementById('msg-pc'), mb = document.getElementById('msg-mob');
                pc.innerHTML = mb.innerHTML = "";
                s.forEach(snap => {
                    const m = snap.val();
                    const html = `<div class="msg animate-msg">
                        <div class="msg-author">${m.pseudo}</div>
                        <div>${m.text.startsWith('[img]') ? `<img src="${m.text.replace('[img]','')}" style="max-width:100%; border-radius:4px;">` : m.text}</div>
                    </div>`;
                    pc.insertAdjacentHTML('beforeend', html); mb.insertAdjacentHTML('beforeend', html);
                });
                pc.scrollTop = pc.scrollHeight; mb.scrollTop = mb.scrollHeight;
                if(s.exists()) document.getElementById('notif-sound').play().catch(()=>{});
            });
            document.getElementById('mob-title').textContent = (type==='room'?'# ':'@ ')+id;
        }

        function handleFile(input) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w=img.width, h=img.height;
                    if(w>800){ h*=800/w; w=800; }
                    canvas.width=w; canvas.height=h;
                    canvas.getContext('2d').drawImage(img,0,0,w,h);
                    const p = current.type==='room'?`messages/public/${current.id}`:`messages/dm/${[user,current.id].sort().join("__")}`;
                    db.ref(p).push({ pseudo: user, text: '[img]'+canvas.toDataURL('image/jpeg',0.5), timestamp: Date.now() });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        function loadData() {
            db.ref("rooms").on('value', s => {
                const pr = document.getElementById('pc-rooms'), mr = document.getElementById('mob-rooms');
                pr.innerHTML = mr.innerHTML = "";
                const saved = JSON.parse(localStorage.getItem("tt_priv") || "[]");
                const render = (id) => {
                    pr.innerHTML += `<div class="pc-item" onclick="setChat('${id}','room')"># ${id}</div>`;
                    mr.innerHTML += `<div class="tile" onclick="setChat('${id}','room');goTo(1)">
                        <div class="live-preview" id="live-${id}">...</div>${id}</div>`;
                };
                render('general');
                s.forEach(r => { if(r.key!=='general' && (!r.val().code || saved.includes(r.key))) render(r.key); });
            });
            db.ref("users").on('value', s => {
                const pc = document.getElementById('pc-contacts'), mc = document.getElementById('mob-contacts');
                pc.innerHTML = mc.innerHTML = "";
                s.forEach(u => {
                    if(u.key === user) return;
                    pc.innerHTML += `<div class="pc-item" onclick="setChat('${u.key}','dm')">@ ${u.key}</div>`;
                    mc.innerHTML += `<div class="tile" style="background:#1a1a1a; border:1px solid #333;" onclick="setChat('${u.key}','dm');goTo(1)">${u.key}</div>`;
                });
            });
        }

        function send(m) {
            const i = document.getElementById(m==='pc'?'in-pc':'in-mob');
            if(!i.value.trim()) return;
            const p = current.type==='room'?`messages/public/${current.id}`:`messages/dm/${[user,current.id].sort().join("__")}`;
            db.ref(p).push({ pseudo: user, text: i.value.trim(), timestamp: Date.now() });
            i.value = "";
        }

        function goTo(x) {
            document.getElementById('panorama').style.transform = `translateX(-${x*100}vw)`;
            document.querySelectorAll('.nav-item').forEach((n,i)=>n.classList.toggle('active', i===x));
            document.getElementById('mob-input-bar').style.display = (x===1)?'flex':'none';
        }

        function initTheme() {
            const colors = ["#00a2e8", "#a200ff", "#008a00", "#e51400", "#ff0097"];
            const cp = document.getElementById('color-picker');
            colors.forEach(c => {
                const d = document.createElement('div'); d.className="color-dot"; d.style.background=c;
                d.onclick=()=>{ document.documentElement.style.setProperty('--accent',c); localStorage.setItem("tt_acc",c); };
                cp.appendChild(d);
            });
            const acc = localStorage.getItem("tt_acc"); if(acc) document.documentElement.style.setProperty('--accent',acc);
            const bg = localStorage.getItem("tt_bg"); if(bg) document.documentElement.style.setProperty('--bg-img',`url(${bg})`);
        }

        function logout() { localStorage.clear(); location.reload(); }
        function changeBg() { const u=prompt("Lien Image :"); if(u){ document.documentElement.style.setProperty('--bg-img',`url(${u})`); localStorage.setItem("tt_bg",u); } }

        window.onload = () => {
            if(!user) {
                openDialog("Bienvenue", `<input id="up" placeholder="PSEUDO" style="width:100%; padding:10px; background:#111; color:white; border:1px solid #333;">`, () => {
                    user = document.getElementById('up').value.trim();
                    if(user) { localStorage.setItem("tt_user", user); db.ref('users/'+user).set(true); location.reload(); }
                });
            } else {
                db.ref('users/'+user).set(true); initTheme(); loadData(); setChat('general', 'room');
            }
        };
    </script>
</body>
</html>
