<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ThinkTalk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        :root { --accent: #00a2e8; --bg: #000; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Segoe UI Light', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg) no-repeat center center fixed; background-size: cover; color: #fff; height: 100vh; overflow: hidden; perspective: 1000px; }

        /* ANIMATIONS COMPLEXES */
        @keyframes flipIn { from { transform: rotateX(-90deg); opacity: 0; } to { transform: rotateX(0); opacity: 1; } }
        @keyframes slidePage { from { transform: translateX(100%) scale(0.9); opacity: 0; } to { transform: translateX(0) scale(1); opacity: 1; } }
        .animate-flip { animation: flipIn 0.5s cubic-bezier(0.1, 0.9, 0.2, 1) forwards; }

        /* TUILES AVEC Ã‰CARTEMENT */
        .tiles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 10px; }
        .tile { 
            background: var(--accent); padding: 15px; height: 140px; 
            display: flex; flex-direction: column; justify-content: flex-end; 
            font-weight: bold; position: relative; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        .tile:hover { transform: scale(1.08); z-index: 10; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .tile:active { transform: scale(0.9) rotateY(10deg); }
        .tile.special { background: #111; border: 2px solid var(--accent); color: var(--accent); }

        /* LISTE PC (FIN ET NOIR) */
        .pc-item { 
            padding: 12px 15px; background: rgba(255,255,255,0.03); 
            margin-bottom: 5px; border-left: 3px solid transparent; 
            cursor: pointer; transition: 0.2s; font-size: 14px;
        }
        .pc-item:hover { background: rgba(255,255,255,0.1); border-left-color: var(--accent); }

        /* CHAT BARRE */
        .input-area { 
            display: flex; align-items: center; gap: 15px; padding: 20px; 
            background: rgba(0,0,0,0.9); border-top: 1px solid #333; width: 100%;
        }
        .input-area input[type="text"] { 
            flex: 1; height: 50px; background: #111; border: 2px solid #333; 
            color: #fff; padding: 0 20px; outline: none; transition: 0.3s;
        }
        .input-area input[type="text"]:focus { border-color: var(--accent); }

        /* TROMBONE BLEU SUR NOIR */
        .btn-attach { 
            width: 50px; height: 50px; border-radius: 50%; background: #000; 
            border: 2px solid var(--accent); display: flex; align-items: center; 
            justify-content: center; cursor: pointer;
        }
        .btn-attach svg { width: 24px; height: 24px; fill: var(--accent); }

        /* LAYOUTS */
        #pc-layout { display: none; height: 100vh; }
        #sidebar { width: 320px; border-right: 1px solid #222; background: #000; display: flex; flex-direction: column; padding: 20px; }
        
        #mobile-layout { display: none; height: 100vh; }
        #panorama { display: flex; width: 300vw; height: 100%; transition: transform 0.5s cubic-bezier(0.1, 0.8, 0.1, 1); }
        .view { width: 100vw; height: 100%; overflow-y: auto; padding: 20px 20px 150px 20px; }

        /* DIALOGS */
        #metro-dialog { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .dialog-box { background: #000; border: 2px solid var(--accent); width: 90%; max-width: 400px; padding: 40px; animation: flipIn 0.4s; }

        .msg-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: #1a1a1a; padding: 15px; border-left: 4px solid #444; width: fit-content; max-width: 80%; }
        .msg.mine { border-left-color: var(--accent); background: #222; align-self: flex-end; }

        @media (min-width: 851px) { #pc-layout { display: flex; } }
        @media (max-width: 850px) { #mobile-layout { display: block; } }
    </style>
</head>
<body>

    <div id="metro-dialog">
        <div class="dialog-box">
            <h2 id="dialog-title" style="font-weight: 100; font-size: 30px; margin-bottom: 20px;"></h2>
            <div id="dialog-body"></div>
            <div style="margin-top: 30px; display: flex; gap: 10px;">
                <button onclick="closeDialog()" style="flex:1; padding:15px; background:none; border:2px solid #fff; color:#fff; cursor:pointer;">annuler</button>
                <button id="dialog-confirm" style="flex:1; padding:15px; background:var(--accent); border:none; color:#fff; cursor:pointer; font-weight:bold;">ok</button>
            </div>
        </div>
    </div>

    <div id="pc-layout">
        <aside id="sidebar">
            <h1 style="font-weight: 100; font-size: 35px; margin-bottom: 20px;">ThinkTalk</h1>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button onclick="openCreateRoom()" style="flex:1; background:var(--accent); border:none; padding:10px; color:white; cursor:pointer;">+ salon</button>
                <button onclick="joinPrivateRoom()" style="flex:1; background:#222; border:1px solid var(--accent); color:var(--accent); cursor:pointer;">ðŸ”‘ privÃ©</button>
            </div>
            <input type="text" placeholder="rechercher..." oninput="filterLists(this.value)" style="width:100%; padding:10px; background:#111; border:1px solid #333; color:white; margin-bottom:20px;">
            <div style="color:var(--accent); font-size:12px; margin-bottom:10px;">SALONS</div>
            <div id="pc-rooms" style="margin-bottom:20px;"></div>
            <div style="color:var(--accent); font-size:12px; margin-bottom:10px;">CONTACTS</div>
            <div id="pc-contacts"></div>
            <button onclick="logout()" style="margin-top:auto; padding:10px; background:#e51400; border:none; color:white; cursor:pointer;">dÃ©connexion</button>
        </aside>
        <main style="flex:1; display:flex; flex-direction:column;">
            <div id="msg-pc" class="msg-list"></div>
            <div class="input-area">
                <input type="file" id="file-pc" hidden accept="image/*" onchange="handleFile(this)">
                <div class="btn-attach" onclick="document.getElementById('file-pc').click()">
                    <svg viewBox="0 0 24 24"><path d="M16.5,6V17.5A4,4 0 0,1 12.5,21.5A4,4 0 0,1 8.5,17.5V5A2.5,2.5 0 0,1 11,2.5A2.5,2.5 0 0,1 13.5,5V15.5A1,1 0 0,1 12.5,16.5A1,1 0 0,1 11.5,15.5V6H10V15.5A2.5,2.5 0 0,0 12.5,18A2.5,2.5 0 0,0 15,15.5V5A4,4 0 0,0 11,1A4,4 0 0,0 7,5V17.5A5.5,5.5 0 0,0 12.5,23A5.5,5.5 0 0,0 18,17.5V6H16.5Z" /></svg>
                </div>
                <input type="text" id="in-pc" placeholder="Message..." onkeypress="if(event.key==='Enter') send('pc')">
            </div>
        </main>
    </div>

    <div id="mobile-layout">
        <div id="panorama">
            <section class="view">
                <h1 style="font-size: 60px; font-weight: 100; margin-bottom: 30px;">salons</h1>
                <div class="tiles-grid">
                    <div class="tile special" onclick="openCreateRoom()">+ nouveau</div>
                    <div class="tile special" onclick="joinPrivateRoom()">ðŸ”‘ privÃ©</div>
                </div>
                <div id="mob-rooms" class="tiles-grid"></div>
            </section>
            <section class="view">
                <h1 id="mob-chat-title" style="font-size: 40px; font-weight: 100; margin-bottom: 20px;">chat</h1>
                <div id="msg-mob" class="msg-list"></div>
            </section>
            <section class="view">
                <h1 style="font-size: 60px; font-weight: 100; margin-bottom: 30px;">contacts</h1>
                <div id="mob-contacts" class="tiles-grid"></div>
            </section>
        </div>
        <div class="input-area" id="mob-bar" style="display:none; position:fixed; bottom:0;">
            <input type="file" id="file-mob" hidden accept="image/*" onchange="handleFile(this)">
            <div class="btn-attach" onclick="document.getElementById('file-mob').click()">
                <svg viewBox="0 0 24 24"><path d="M16.5,6V17.5A4,4 0 0,1 12.5,21.5A4,4 0 0,1 8.5,17.5V5A2.5,2.5 0 0,1 11,2.5A2.5,2.5 0 0,1 13.5,5V15.5A1,1 0 0,1 12.5,16.5A1,1 0 0,1 11.5,15.5V6H10V15.5A2.5,2.5 0 0,0 12.5,18A2.5,2.5 0 0,0 15,15.5V5A4,4 0 0,0 11,1A4,4 0 0,0 7,5V17.5A5.5,5.5 0 0,0 12.5,23A5.5,5.5 0 0,0 18,17.5V6H16.5Z" /></svg>
            </div>
            <input type="text" id="in-mob" placeholder="Message..." onkeypress="if(event.key==='Enter') send('mob')">
        </div>
        <div style="position:fixed; bottom:70px; width:100%; display:flex; justify-content:center; gap:20px; background:rgba(0,0,0,0.8); padding:10px; font-weight: bold; font-size: 12px;">
            <span onclick="goTo(0)" style="cursor:pointer">SALONS</span>
            <span onclick="goTo(1)" style="cursor:pointer">CHAT</span>
            <span onclick="goTo(2)" style="cursor:pointer">CONTACTS</span>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCrgPMXzSyS6NXNajPxr0x_J-CTESOtp5w", authDomain: "chat-github-6abb5.firebaseapp.com", databaseURL: "https://chat-github-6abb5-default-rtdb.europe-west1.firebasedatabase.app", projectId: "chat-github-6abb5" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let user = localStorage.getItem("tt_user"), current = { id: 'general', type: 'room' };

        // --- DIALOGUES ---
        function openDialog(title, body, confirm) {
            document.getElementById('metro-dialog').style.display = 'flex';
            document.getElementById('dialog-title').textContent = title;
            document.getElementById('dialog-body').innerHTML = body;
            document.getElementById('dialog-confirm').onclick = () => { confirm(); closeDialog(); };
        }
        function closeDialog() { document.getElementById('metro-dialog').style.display = 'none'; }

        // --- COMPRESSION D'IMAGE ---
        function handleFile(input) {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height, max = 800;
                    if (width > height && width > max) { height *= max / width; width = max; }
                    else if (height > max) { width *= max / height; height = max; }
                    canvas.width = width; canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    const compressed = canvas.toDataURL('image/jpeg', 0.6); // Compression 60%
                    const path = current.type === 'room' ? `messages/public/${current.id}` : `messages/dm/${[user,current.id].sort().join("__")}`;
                    db.ref(path).push({ pseudo: user, text: '[img]' + compressed, timestamp: Date.now() });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        // --- AUTO-CLEAN (48H) ---
        function runAutoClean() {
            const limit = Date.now() - (48 * 60 * 60 * 1000);
            const clean = (ref) => {
                db.ref(ref).once('value', s => {
                    s.forEach(child => {
                        child.forEach(msg => {
                            if (msg.val().timestamp && msg.val().timestamp < limit) msg.ref.remove();
                        });
                    });
                });
            };
            clean("messages/public"); clean("messages/dm");
        }

        // --- LOGIQUE CHAT ---
        function setChat(id, type) {
            current = { id, type };
            const path = type === 'room' ? `messages/public/${id}` : `messages/dm/${[user,id].sort().join("__")}`;
            db.ref(path).off();
            db.ref(path).on('value', s => {
                const pc = document.getElementById('msg-pc'), mb = document.getElementById('msg-mob');
                pc.innerHTML = ""; mb.innerHTML = "";
                s.forEach(snap => {
                    const m = snap.val();
                    const html = `<div class="msg animate-flip ${m.pseudo === user ? 'mine' : ''}">
                        <div style="font-size:10px; color:var(--accent);">${m.pseudo}</div>
                        <div>${m.text.startsWith('[img]') ? `<img src="${m.text.replace('[img]','')}" style="max-width:100%; margin-top:5px; display:block;">` : m.text}</div>
                    </div>`;
                    pc.insertAdjacentHTML('beforeend', html); mb.insertAdjacentHTML('beforeend', html);
                });
                pc.scrollTop = pc.scrollHeight; mb.scrollTop = mb.scrollHeight;
            });
            document.getElementById('mob-chat-title').textContent = id;
        }

        function loadData() {
            db.ref("rooms").on('value', s => {
                const pc = document.getElementById('pc-rooms'), mb = document.getElementById('mob-rooms');
                pc.innerHTML = ""; mb.innerHTML = "";
                const saved = JSON.parse(localStorage.getItem("tt_priv") || "[]");
                const render = (id) => {
                    pc.innerHTML += `<div class="pc-item" onclick="setChat('${id}','room')"># ${id}</div>`;
                    mb.innerHTML += `<div class="tile animate-flip" onclick="setChat('${id}','room');goTo(1)">${id}</div>`;
                };
                render('general');
                s.forEach(r => { if(r.key !== 'general' && (!r.val().code || saved.includes(r.key))) render(r.key); });
            });
            db.ref("users").on('value', s => {
                const pc = document.getElementById('pc-contacts'), mb = document.getElementById('mob-contacts');
                pc.innerHTML = ""; mb.innerHTML = "";
                s.forEach(u => {
                    if(u.key === user) return;
                    pc.innerHTML += `<div class="pc-item" onclick="setChat('${u.key}','dm')">@ ${u.key}</div>`;
                    mb.innerHTML += `<div class="tile animate-flip" style="background:#222" onclick="setChat('${u.key}','dm');goTo(1)">${u.key}</div>`;
                });
            });
        }

        function send(m) {
            const i = document.getElementById(m === 'pc' ? 'in-pc' : 'in-mob');
            if(!i.value.trim()) return;
            const path = current.type === 'room' ? `messages/public/${current.id}` : `messages/dm/${[user,current.id].sort().join("__")}`;
            db.ref(path).push({ pseudo: user, text: i.value.trim(), timestamp: Date.now() });
            i.value = "";
        }

        function openCreateRoom() {
            openDialog("nouveau salon", `<input type="text" id="rn" placeholder="nom" style="width:100%;padding:10px;background:#111;border:1px solid #333;color:white;"><input type="text" id="rc" placeholder="code (optionnel)" style="width:100%;padding:10px;background:#111;border:1px solid #333;color:white;margin-top:10px;">`, () => {
                const n = document.getElementById('rn').value.trim();
                const c = document.getElementById('rc').value.trim();
                if(n) db.ref('rooms/'+n).set({code: c || null});
            });
        }

        function joinPrivateRoom() {
            openDialog("rejoindre privÃ©", `<input type="text" id="jn" placeholder="nom" style="width:100%;padding:10px;background:#111;border:1px solid #333;color:white;"><input type="text" id="jc" placeholder="code" style="width:100%;padding:10px;background:#111;border:1px solid #333;color:white;margin-top:10px;">`, () => {
                const n = document.getElementById('jn').value.trim(), c = document.getElementById('jc').value.trim();
                db.ref('rooms/'+n).once('value', snap => {
                    if(snap.exists() && snap.val().code === c) {
                        let p = JSON.parse(localStorage.getItem("tt_priv") || "[]");
                        if(!p.includes(n)) p.push(n);
                        localStorage.setItem("tt_priv", JSON.stringify(p));
                        loadData();
                    }
                });
            });
        }

        function goTo(x) {
            document.getElementById('panorama').style.transform = `translateX(-${x*100}vw)`;
            document.getElementById('mob-bar').style.display = (x === 1) ? 'flex' : 'none';
        }
        function logout() { localStorage.clear(); location.reload(); }

        window.onload = () => {
            if(!user) {
                openDialog("ton pseudo", `<input type="text" id="up" style="width:100%;padding:10px;background:#111;border:1px solid #333;color:white;">`, () => {
                    user = document.getElementById('up').value.trim();
                    if(user) { localStorage.setItem("tt_user", user); db.ref('users/'+user).set(true); location.reload(); }
                });
            } else {
                db.ref('users/'+user).set(true); loadData(); setChat('general', 'room');
                runAutoClean(); setInterval(runAutoClean, 12 * 60 * 60 * 1000);
            }
        };
    </script>
</body>
</html>
