<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ThinkTalk ‚Äî Mobile</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<!-- üî• Firebase (OBLIGATOIRE et DOIT √™tre dans le head) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
/* Ton design mobile (inchang√©) */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,Arial;background:#000;color:#d0e7ff;display:flex;justify-content:center;height:100vh;overflow:hidden}
#app{width:100%;max-width:480px;height:100%;background:radial-gradient(circle at top left,rgba(0,153,255,.1),#000);border-left:1px solid #0084ff55;border-right:1px solid #0084ff55;display:flex;flex-direction:column;position:relative}

header{height:52px;border-bottom:1px solid #0084ff55;display:flex;align-items:center;padding:0 15px;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:10}
#main{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:10px;scrollbar-width:none}

.msg{padding:8px 12px;border-radius:12px;background:rgba(0,132,255,0.1);border-left:3px solid #0084ff;max-width:85%;animation:fadeIn 0.2s}
.msg.me{align-self:flex-end;border-left:none;border-right:3px solid #0084ff;background:rgba(0,204,255,0.05)}
.pseudo{font-size:12px;font-weight:bold;color:#7fc4ff;display:block;margin-bottom:4px}
.text{font-size:14px;line-height:1.4;white-space:pre-wrap}

#inputBar{padding:10px;background:rgba(0,0,0,0.9);border-top:1px solid #0084ff55;display:flex;gap:8px}
input{flex:1;background:#111;border:1px solid #0084ff88;border-radius:20px;padding:8px 15px;color:#fff;outline:none}
button{background:#0084ff;color:#fff;border:none;border-radius:20px;padding:0 15px;cursor:pointer;font-weight:bold}

#bottomBar{height:60px;border-top:1px solid #0084ff55;display:flex;justify-content:space-around;align-items:center;background:#000}
.navBtn{text-align:center;font-size:11px;color:#666;cursor:pointer}
.navBtn.active{color:#0084ff;text-shadow:0 0 10px #0084ff}

#authOverlay{position:fixed;inset:0;background:#000;z-index:100;display:flex;align-items:center;justify-content:center;padding:20px}
.authBox{width:100%;max-width:300px;display:flex;flex-direction:column;gap:10px}

@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>

<body>

<!-- üîê AUTH -->
<div id="authOverlay">
    <div class="authBox">
        <h2 style="text-align:center">THINKTALK</h2>
        <input id="authPseudo" placeholder="Pseudo">
        <input id="authCode" placeholder="Code secret (4-8 chiffres)" type="password">
        <button onclick="handleAuth(true)">Cr√©er un compte</button>
        <button onclick="handleAuth(false)" style="background:none;border:1px solid #0084ff">Se connecter</button>
    </div>
</div>

<!-- üì± APP MOBILE -->
<div id="app">
    <header><h1 id="viewTitle" style="font-size:18px">ThinkTalk</h1></header>
    <div id="main"></div>

    <div id="inputBar">
        <input id="messageInput" placeholder="Message...">
        <button onclick="sendMessage()">Envoyer</button>
    </div>

    <div id="bottomBar">
        <div class="navBtn active" onclick="showHome()">üè†<br>Home</div>
        <div class="navBtn" onclick="showRooms()">üí¨<br>Salons</div>
        <div class="navBtn" onclick="showContacts()">üë§<br>Contacts</div>
    </div>
</div>

<!-- üî• SCRIPT MOBILE ENTIER -->
<script>
// -------------------- CONFIG FIREBASE --------------------
const firebaseConfig = {
    apiKey: "AIzaSyCrgPMXzSyS6NXNajPxr0x_J-CTESOtp5w",
    authDomain: "chat-github-6abb5.firebaseapp.com",
    databaseURL: "https://chat-github-6abb5-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "chat-github-6abb5",
    storageBucket: "chat-github-6abb5.firebasestorage.app",
    messagingSenderId: "1038562300660",
    appId: "1:1038562300660:web:b57b74a7539466e16384a1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
let currentUID = null;
let currentContext = { type: "room", id: "general" };
let msgRef = null;

// -------------------- AUTH ANONYME --------------------
firebase.auth().onAuthStateChanged(user => {
    if (user) {
        currentUID = user.uid;
    } else {
        firebase.auth().signInAnonymously().catch(console.error);
    }
});

// -------------------- AUTH PSEUDO + CODE --------------------
async function handleAuth(isNew) {
    const p = authPseudo.value.trim();
    const c = authCode.value.trim();

    if (p.length < 3 || c.length < 4) return alert("Pseudo (3+) ou Code (4+) trop court");

    const snap = await db.ref("users/" + p).get();

    if (isNew) {
        if (snap.exists()) return alert("Pseudo d√©j√† pris");
        await db.ref("users/" + p).set({ uid: currentUID, code: c });
    } else {
        if (!snap.exists() || snap.val().code !== c) return alert("Identifiants incorrects");
        if (snap.val().uid !== currentUID) await db.ref("users/" + p).update({ uid: currentUID });
    }

    currentUser = p;
    localStorage.setItem("tt_user", p);
    authOverlay.style.display = "none";

    loadChat("room", "general", "#General");
}

// Auto-login
if (localStorage.getItem("tt_user")) {
    currentUser = localStorage.getItem("tt_user");
    authOverlay.style.display = "none";
    loadChat("room", "general", "#General");
}

// -------------------- CHARGEMENT DES MESSAGES --------------------
function loadChat(type, id, title) {
    if (msgRef) msgRef.off();

    currentContext = { type, id };
    viewTitle.textContent = title;

    main.innerHTML = "";

    const path = type === "room"
        ? "messages/public/" + id
        : "messages/dm/" + id;

    msgRef = db.ref(path).limitToLast(50);

    msgRef.on("child_added", snap => {
        const msg = snap.val();

        const div = document.createElement("div");
        div.className = "msg " + (msg.uid === currentUID ? "me" : "");

        const pseudoSpan = document.createElement("span");
        pseudoSpan.className = "pseudo";
        pseudoSpan.textContent = msg.pseudo;

        const textDiv = document.createElement("div");
        textDiv.className = "text";
        textDiv.textContent = msg.text;

        div.append(pseudoSpan, textDiv);
        main.appendChild(div);
        main.scrollTop = main.scrollHeight;
    });
}

// -------------------- ENVOI MESSAGE --------------------
function sendMessage() {
    if (!currentUser) return alert("Connecte-toi d'abord.");

    const text = messageInput.value.trim();
    if (!text) return;
    if (text.length > 10000) return alert("Message trop long");

    const path = currentContext.type === "room"
        ? "messages/public/" + currentContext.id
        : "messages/dm/" + currentContext.id;

    db.ref(path).push({
        pseudo: currentUser,
        uid: currentUID,
        text,
        timestamp: Date.now()
    });

    messageInput.value = "";
}

// -------------------- NAVIGATION --------------------
function showHome() {
    loadChat("room", "general", "#General");
}
function showRooms() {
    const r = prompt("Nom du salon :");
    if (r) loadChat("room", r.toLowerCase(), "#" + r);
}
function showContacts() {
    const target = prompt("Pseudo du contact :");
    if (target) {
        const id = [currentUser, target].sort().join("__");
        loadChat("dm", id, "@" + target);
    }
}
</script>

</body>
</html>
